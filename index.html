<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alchemy Factory Planner v95</title>
    <script src="alchemy_db.js"></script> 
    <script src="alchemy_constants.js"></script> 

    <script src="alchemy_i18n.js"></script>
    
    <style>
        /* ==========================================================================
           SECTION: CSS - CORE THEME & VARIABLES
           ========================================================================== */
        :root { 
            --bg: #1a1a1a; --text: #e0e0e0; --accent: #4caf50; 
            --panel: #2d2d2d; --border: #444; --warn: #ff9800; 
            --gold: #ffd700; --info: #2196f3; --profit: #00e676; 
            --bio: #76ff03; --fuel: #ff5722; --danger: #f44336;
            --row-id: #4fc3f7; --byproduct: #9c27b0;
            --thumb-size: 14px; /* Variable for slider thumb calculations */
        }
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); color: var(--text); 
            padding: 0; margin: 0; height: 100vh; 
            display: flex; flex-direction: column; 
            font-size: 13px; 
        }
        
        /* ==========================================================================
           SECTION: CSS - LAYOUT & GRID
           ========================================================================== */
        header { 
            background: #111; padding: 8px 20px; 
            border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: space-between; 
            flex-shrink: 0; 
        }
        h1 { color: var(--accent); margin: 0; font-size: 1.1em; }
        .repo-link { 
            color: #888; text-decoration: none; font-size: 0.9em; 
            margin-right: 15px; border: 1px solid #444; padding: 4px 8px; 
            border-radius: 4px; transition: 0.2s; 
        }
        .repo-link:hover { color: #fff; border-color: #666; background: #222; }
        .subtitle { color: #888; font-size: 0.8em; margin-left: 10px; cursor: pointer; text-decoration: underline; }
        .subtitle:hover { color: #fff; }
        
        .tabs { display: flex; gap: 5px; }
        .tab-btn { 
            background: #222; border: 1px solid var(--border); 
            color: #888; padding: 6px 12px; cursor: pointer; 
            border-radius: 4px; font-size: 0.9em; 
        }
        .tab-btn:hover { background: #333; color: #fff; }
        .tab-btn.active { background: var(--accent); color: white; border-color: var(--accent); font-weight: bold; }

        main { flex: 1; overflow: hidden; position: relative; }
        .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; padding: 15px; display: none; }
        .view.active { display: block; }
        
        .app-grid { 
            display: grid; 
            grid-template-columns: 260px 1fr 220px 200px; 
            gap: 15px; 
            max-width: 1920px; margin: 0 auto; height: 100%; 
        }
        .panel { 
            background: var(--panel); padding: 12px; 
            border-radius: 8px; border: 1px solid var(--border); 
            margin-bottom: 15px; 
        }
        .panel h3 { 
            margin-top: 0; color: #fff; border-bottom: 1px solid #444; 
            padding-bottom: 8px; font-size: 1.05em; margin-bottom: 10px; 
        }

        /* ==========================================================================
           SECTION: CSS - CONTROLS & INPUTS
           ========================================================================== */
        .input-group { margin-bottom: 12px; position: relative; }
        label { display: block; font-size: 0.85em; color: #aaa; margin-bottom: 4px; }
        select { width: 100%; padding: 6px; background: #333; border: 1px solid #555; color: white; border-radius: 4px; font-size: 1em; }
        
        /* ==========================================================================
           SECTION: CSS - SLIDER COMPONENTS
           ========================================================================== */
        .slider-container { position: relative; width: 100%; height: 50px; margin-top: 5px; }
        input[type=range] {
            width: 100%; -webkit-appearance: none; background: transparent; cursor: pointer; position: relative; z-index: 10;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; background: #444; border-radius: 3px;
        }
        
        /* THUMB: Downward Triangle Pointer */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; 
            height: var(--thumb-size); width: var(--thumb-size); 
            background: var(--accent); 
            margin-top: -6px; /* Center on track */
            border: none;
            clip-path: polygon(0% 0%, 100% 0%, 50% 100%);
            transform: none;
            border-radius: 0; 
            position: relative;
            z-index: 20;
        }
        input[type=range]:focus { outline: none; }
        
        .slider-ticks {
            position: absolute; top: 14px; left: 0; right: 0; height: 20px; pointer-events: none;
        }
        .tick-mark {
            position: absolute; display: flex; flex-direction: column; align-items: center; transform: translateX(-50%);
        }
        .tick-line { width: 1px; height: 6px; background: #666; margin-bottom: 2px; }
        .tick-mark.labeled .tick-line { height: 8px; background: #999; }
        
        /* Vertical Fractions Logic */
        .vertical-frac { 
            display: flex; flex-direction: column; align-items: center; 
            color: #888; font-family: sans-serif; font-size: 9px; line-height: 1;
        }
        .vertical-frac .num { margin-bottom: 2px; }
        .vertical-frac .sep { width: 8px; height: 1px; background: #666; opacity: 0.7; }
        .vertical-frac .den { margin-top: 2px; }
        .vertical-frac.full-label { font-size: 10px; margin-top: 2px; }

        /* ==========================================================================
           SECTION: CSS - COMBOBOX
           ========================================================================== */
        .combobox-container { position: relative; width: 100%; }
        .input-wrapper { position: relative; display: flex; align-items: center; background: #333; border: 1px solid #555; border-radius: 4px; }
        .real-input {
            width: 100%; background: transparent; border: none; color: white; padding: 6px; font-size: 1em; z-index: 2; position: relative;
        }
        .real-input:focus { outline: none; border-color: var(--accent); }
        .ghost-input {
            position: absolute; top: 6px; left: 7px;
            color: #666; font-size: 1em; z-index: 1; pointer-events: none; white-space: pre;
        }
        .combo-arrow { padding: 0 8px; color: #888; font-size: 0.8em; cursor: pointer; z-index: 3; user-select: none; }
        .combo-arrow:hover { color: #fff; }
        .combobox-list {
            position: absolute; top: 100%; left: 0; right: 0;
            background: #252525; border: 1px solid #444; border-radius: 4px;
            max-height: 300px; overflow-y: auto; z-index: 100; display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); margin-top: 2px;
        }
        .combobox-list.active { display: block; }
        .combo-item { padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #333; font-size: 0.95em; display: flex; justify-content: space-between; }
        .combo-item:hover, .combo-item.selected { background: #333; color: white; }
        .combo-item.selected { border-left: 3px solid var(--accent); background: #2e3d30; }
        .combo-cat { font-size: 0.75em; color: #666; font-style: italic; }

        /* ==========================================================================
           SECTION: CSS - SPINNERS & BUTTONS
           ========================================================================== */
        .spinner-wrapper { display: flex; align-items: stretch; width: 100%; height: 32px; }
        .spinner-btn { background: #444; border: 1px solid #555; color: white; padding: 0 10px; cursor: pointer; font-size: 0.9em; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: 0.1s; min-width: 32px; }
        .spinner-btn:hover { background: #555; }
        .spinner-btn:active { background: var(--accent); }
        .spinner-btn.left { border-right: none; }
        .spinner-btn.right { border-left: none; }
        .spinner-btn.first { border-radius: 4px 0 0 4px; }
        .spinner-btn.last { border-radius: 0 4px 4px 0; }
        
        input[type="number"] { flex: 1; text-align: center; font-size: 1.1em; background: #333; border: 1px solid #555; border-left: 1px solid #444; border-right: 1px solid #444; color: white; width: 10px; -moz-appearance: textfield; }
        input:disabled { opacity: 0.5; cursor: not-allowed; background: #2a2a2a; color: #aaa; }
        
        .split-btn-container { display: flex; gap: 5px; margin-top: 6px; }
        .split-btn { flex: 1; padding: 6px 4px; border: 1px solid #555; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: bold; transition: 0.2s; color: #ddd; background: #333; text-align: center; }
        .split-btn:hover:not(:disabled) { background: #444; color: #fff; }
        .btn-active-green { background: #2e7d32 !important; border-color: #4caf50 !important; color: white !important; }
        .btn-inactive-red { background: #333 !important; color: #aaa !important; }
        .checkbox-row { display: flex; align-items: center; margin-top: 8px; font-size: 0.9em; color: #ccc; }
        .checkbox-row input { margin-right: 8px; }

        /* ==========================================================================
           SECTION: CSS - TOGGLE SWITCH
           ========================================================================== */
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 18px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-switch {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #444; transition: .3s;
            border-radius: 18px;
        }
        .slider-switch:before {
            position: absolute; content: "";
            height: 12px; width: 12px;
            left: 3px; bottom: 3px;
            background-color: white; transition: .3s;
            border-radius: 50%;
        }
        input:checked + .slider-switch { background-color: var(--accent); }
        input:checked + .slider-switch:before { transform: translateX(16px); }

        /* Highlight current mode label */
        .active-mode { color: var(--accent) !important; }

        /* ==========================================================================
           SECTION: CSS - CONSTRUCTION LIST
           ========================================================================== */
        .build-list { list-style: none; padding: 0; margin: 0; }
        .build-group { margin-bottom: 2px; }
        .build-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 6px 8px; background: #333; border-radius: 4px; cursor: pointer; 
            font-weight: bold; color: #ccc; border: 1px solid transparent; user-select: none;
        }
        .build-header:hover { background: #444; border-color: #555; color: #fff; }
        .build-arrow { font-size: 0.8em; margin-right: 8px; transition: transform 0.1s; display: inline-block; width: 10px; }
        .expanded .build-arrow { transform: rotate(90deg); }
        .build-sublist { list-style: none; padding: 0 0 0 10px; margin: 0; display: none; border-left: 2px solid #444; margin-left: 10px; }
        .expanded .build-sublist { display: block; }
        .build-subitem { display: flex; justify-content: space-between; padding: 4px 8px; font-size: 0.9em; color: #aaa; border-bottom: 1px dashed #333; }
        .build-subitem:last-child { border-bottom: none; }
        .build-val { color: var(--gold); }
        .total-mats-header { margin-top: 20px; border-top: 1px solid #555; padding-top: 10px; font-weight: bold; color: var(--accent); text-transform: uppercase; font-size: 0.9em; }
        .total-mat-item { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #333; font-size: 0.95em; color: #ddd; }
        
        /* ==========================================================================
           SECTION: CSS - SUMMARY BOX
           ========================================================================== */
        .summary-box { background: #252525; border-left: 4px solid var(--accent); padding: 12px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 10px; }
        .stat-block { display: flex; flex-direction: column; padding-right: 10px; border-right: 1px solid #444; }
        .stat-block:last-child { border-right: none; }
        .stat-label { font-size: 0.75em; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-size: 1.1em; font-weight: bold; color: #fff; margin-top: 4px; }
        .stat-sub { font-size: 0.85em; color: var(--warn); margin-top: 2px; }
        .gold-profit { color: var(--profit); } .gold-cost { color: var(--gold); } .net-positive { color: #69f0ae; }

        /* ==========================================================================
           SECTION: CSS - TREE NODES
           ========================================================================== */
        .node { margin-left: 15px; padding: 4px 0; border-left: 2px solid #555; position: relative; }
        .node-content { display: flex; align-items: center; gap: 8px; background: #222; padding: 6px 10px; border-radius: 4px; border: 1px solid #333; }
        .tree-arrow { display: inline-block; width: 14px; cursor: pointer; transition: transform 0.1s; user-select: none; font-size: 0.8em; color: #888; text-align:center; }
        .row-id { color: var(--row-id); font-family: monospace; font-weight: bold; min-width: 20px; font-size: 0.9em; cursor: pointer; }
        .node.collapsed .node-children { display: none; }
        .node.collapsed .tree-arrow { transform: rotate(-90deg); }
        .node-children { margin-left: 0; }

        .qty { color: var(--accent); font-weight: bold; min-width: 50px; }
        .item-link { cursor: pointer; text-decoration: none; color: inherit; transition: 0.2s; }
        .item-link:hover { color: var(--info); text-decoration: underline; }
        .machine-tag { background: #333; padding: 2px 6px; border-radius: 3px; font-size: 0.85em; border: 1px solid #444; color: #fff; font-weight: bold; cursor: help; }
        .heat-tag { color: var(--warn); font-size: 0.85em; margin-left: 5px; }
        .bio-tag { color: var(--bio); font-size: 0.85em; margin-left: 5px; }
        .cost-tag { color: var(--gold); font-size: 0.85em; margin-left: 10px; font-weight: bold; }
        .fail-tag { color: var(--danger); font-size: 0.85em; margin-left: 5px; font-weight: bold; }
        .max-cap-tag { color: #888; font-size: 0.8em; margin-left: 5px; font-style: italic; }
        .details { font-size: 0.9em; color: #ccc; }
        .output-tag { color: var(--info); font-size: 0.85em; margin-left: 10px; font-weight: bold; border-left: 1px solid #555; padding-left: 10px; }
        .recycle-tag { color: var(--byproduct); font-size: 0.85em; margin-left: 10px; font-weight: bold; }
        .swap-btn { background: transparent; border: 1px solid #555; color: #888; width: 22px; height: 22px; border-radius: 50%; font-size: 11px; cursor: pointer; margin-left: 10px; display: inline-flex; align-items: center; justify-content: center; padding: 0; line-height: 1; }
        .swap-btn:hover { background: #444; color: white; border-color: #fff; }
        
        .push-right { margin-left: auto; display: flex; align-items: center; }
        .recycle-btn { background: transparent; border: 1px solid var(--byproduct); color: var(--byproduct); border-radius: 4px; font-size: 0.8em; cursor: pointer; padding: 2px 8px; font-weight:bold; transition:0.2s; }
        .recycle-btn:hover { background: rgba(156, 39, 176, 0.2); }
        .recycle-btn.active { background: #2e3d30; color: var(--profit); border-color: var(--profit); }
        
        .section-header { margin-top: 25px; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px dashed #555; color: #888; text-transform: uppercase; letter-spacing: 1px; font-size: 0.85em; font-weight: bold; }

        /* ==========================================================================
           SECTION: CSS - MODALS & EDITOR
           ========================================================================== */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--panel); border: 1px solid var(--border); width: 600px; max-width: 90%; max-height: 80vh; overflow-y: auto; padding: 20px; border-radius: 8px; }
        .modal-header { display: flex; justify-content: space-between; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 10px; }
        .close-modal { background: none; border: none; color: #aaa; font-size: 1.5em; cursor: pointer; }
        .close-modal:hover { color: #fff; }
        .recipe-option { background: #333; border: 1px solid #444; padding: 10px; margin-bottom: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; flex-direction: column; align-items: flex-start; }
        .recipe-option.active { border-color: var(--accent); background: #2e3d30; }
        .recipe-option.disabled { opacity: 0.6; cursor: not-allowed; background: #3e2a2a; border-color: #d32f2f; }
        .recipe-header { font-weight: bold; font-size: 1.1em; margin-bottom: 4px; display:flex; justify-content:space-between; width:100%; }
        .recipe-details { font-size: 0.9em; color: #aaa; }
        .loop-warning { color: #ef5350; font-size: 0.85em; font-weight: bold; margin-top: 4px; }
        
        #update-banner{display:none;background:var(--warn);color:#000;padding:10px 20px;font-weight:bold;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:2000;box-shadow:0 2px 10px rgba(0,0,0,0.3);}
        .update-btns{display:flex;gap:10px;}.update-btn{background:#000;color:#fff;border:none;padding:5px 15px;border-radius:4px;cursor:pointer;font-size:0.9em;}
        .update-btn:hover{background:#333;}.update-btn.secondary{background:transparent;color:#000;border:1px solid #000;}

        /* Item Picker Styles */       
        .picker-category { margin-bottom: 8px; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
        .picker-cat-header { 
            background: #333; padding: 10px 15px; cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold;
        }
        .picker-cat-header:hover { background: #444; }
        .picker-cat-header .arrow { transition: transform 0.2s; font-size: 0.8em; }
        .picker-category.collapsed .picker-cat-header .arrow { transform: rotate(-90deg); }
        .picker-category.collapsed .picker-grid { display: none; }

        .picker-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); 
            gap: 8px; padding: 12px; background: #252525; 
        }
        .picker-item { 
            background: #3a3a3a; border: 1px solid #444; padding: 10px 5px; 
            border-radius: 4px; text-align: center; cursor: pointer; 
            font-size: 0.9em; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .picker-item:hover { background: var(--accent); border-color: #fff; color: #fff; transform: translateY(-2px); }
        .picker-item.active { border-color: var(--accent); background: #2e3d30; box-shadow: inset 0 0 5px var(--accent); }

        .editor-container { max-width: 1400px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; }
        #json-editor { flex: 1; background: #151515; color: #a5d6a7; font-family: 'Consolas', 'Courier New', monospace; border: 1px solid #444; padding: 15px; resize: none; line-height: 1.4; white-space: pre; }
        .editor-toolbar { margin-bottom: 10px; display: flex; gap: 10px; }
        button.save-btn { width: 100%; margin-top: 10px; background: #333; border: 1px solid var(--accent); color: var(--accent); padding: 8px; cursor: pointer; font-weight: bold; font-size: 0.9em; }
        button.save-btn:hover { background: var(--accent); color: white; }
        button.reset-btn { width: 100%; margin-top: 15px; background: transparent; border: 1px solid var(--danger); color: var(--danger); font-size:0.8em; padding: 5px; cursor: pointer; }
        button.reset-btn:hover { background: var(--danger); color: white; }
    </style>
</head>
<body>
    <div id="update-banner">
        <span>
        ðŸš€ <span id="ui-update-msg">New database version available</span> (<span id="new-version-id">v0</span>)! 
            <span id="ui-update-local-msg">Current local version:</span> <span id="old-version-id">v0</span>
        </span>
        <div class="update-btns">
            <button id="ui-btn-update" class="update-btn" onclick="performUpdate()">Update Now</button>
            <button id="ui-btn-later" class="update-btn secondary" onclick="closeUpdateBanner()">Skip Update</button>
        </div>
    </div>

    <header>
        <div style="display:flex; align-items:baseline;">
            <h1>Alchemy Factory Planner</h1>
            <span style="margin-left: 20px;">
                <a href="https://github.com/JoeJoesGit/AlchemyFactoryCalculator" target="_blank" class="repo-link">GitHub Repo</a>
                <span class="subtitle" onclick="showChangelog()">v95 | View Changelog</span>
            </span>
        </div>
        <div class="tabs">
            <div class="tab-btn active" onclick="switchTab('calc')">Calculator</div>
            <div class="tab-btn" onclick="switchTab('db')">Database Editor</div>
        </div>
    </header>

    <main>
        <div id="changelog-modal" class="modal-overlay" onclick="closeModal('changelog-modal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header"><h2>Changelog</h2><button class="close-modal" onclick="closeModal('changelog-modal')">&times;</button></div>
                <div style="line-height:1.6; color:#ccc;">
					<strong>v95 - Stability & Math Overhaul</strong><br>
					- <strong>Critical Fix:</strong> Stone Furnaces now pool slots globally across the factory (e.g., 23 Crucibles correctly ask for 8 Furnaces).<br>
					- <strong>Fix:</strong> Summary Box "Gross/Use" logic is now accurate.<br>
					- <strong>Fix:</strong> Internal Modules (Heat/Nutrients) now correctly contribute to Global Load stats.<br>
					- <strong>Fix:</strong> Selecting a new item now auto-resets the Target Rate to match Belt settings.<br>
					- <strong>Logic:</strong> Construction List "Min" now assumes merging identical outputs; "Max" counts physical nodes.<br><br>
					<strong>v94 - Calculation & Data Overhaul</strong><br>
					- <strong>Critical Fix:</strong> Stone Furnace counts now scale correctly with upgrades (Heat Overhead now scales with Speed).<br>
					- <strong>Logic:</strong> Rewrote Construction List math. "Min" now assumes merging identical outputs; "Max" counts physical nodes.<br>
					- <strong>Data:</strong> Added "Enhanced Grinder" (2x Speed) alternate recipes for all grinding tasks.<br>
					- <strong>UI:</strong> Fixed vertical alignment of the Recipe Swap button.<br><br>
                    <strong>v93 - Slider Alignment Fix</strong><br>
                    - <strong>UI Fix:</strong> Corrected slider tick alignment to perfectly match handle position.<br>
                    - <strong>UI Update:</strong> Changed slider handle to a "Diamond" style.<br>
                    - <strong>UI Update:</strong> Converted fraction labels to vertical stacks for better readability.<br><br>
                    <strong>v92 - Smart Slider & Feedback</strong><br>
                    - <strong>UI:</strong> Added smart feedback label to Rate box (shows % and ~Fraction).<br>
                    <a href="https://github.com/JoeJoesGit/AlchemyFactoryCalculator/blob/main/CHANGELOG.md" target="_blank" style="color:var(--accent);">View Full History on GitHub</a>
                </div>
            </div>
        </div>

        <div id="recipe-modal" class="modal-overlay" onclick="closeModal('recipe-modal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h2 id="recipe-modal-title">Select Recipe</h2>
                    <button class="close-modal" onclick="closeModal('recipe-modal')">&times;</button>
                </div>
                <div id="recipe-list"></div>
            </div>
        </div>

        <!-- Item Picker Modal -->
        <div id="picker-modal" class="modal-overlay" onclick="closeModal('picker-modal')">
            <div class="modal-content picker-modal-content" style="width: 800px; max-width: 95vw;" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <h2 id="ui-picker-title" style="margin:0;">Select Target Item</h2>
                        <!-- New toggle buttons -->
                        <div class="picker-controls">
                            <button id="ui-picker-expand-all" class="split-btn" onclick="toggleAllCategories(false)">Expand All</button>
                            <button id="ui-picker-collapse-all" class="split-btn" onclick="toggleAllCategories(true)">Collapse All</button>
                        </div>
                    </div>
                    <button class="close-modal" onclick="closeModal('picker-modal')">&times;</button>
                </div>
                <!-- Scrollable area is separate from header -->
                <div id="picker-body" class="picker-scroll-area">
                    <!-- Categories will be injected here -->
                </div>
            </div>
        </div>

        <div id="view-calc" class="view active">
            <div class="app-grid">
                <div>
                    <div class="panel">
                        <h3>Production Goal</h3>
                        <div class="input-group">
                            <label>Target Item</label>
                            <div class="combobox-container" id="targetCombobox">
                                <div class="input-wrapper" onclick="toggleCombobox()">
                                    <div id="ghost-text" class="ghost-input"></div>
                                    <input type="text" id="targetItemInput" class="real-input" placeholder="Select or Type..." autocomplete="off" oninput="filterCombobox(); updateComboIcon();" onkeydown="handleComboKey(event)" onblur="closeComboboxDelayed()">
                                    <div class="combo-arrow" onclick="openItemPicker()" title="Browse Items">â˜°</div>
                                    <div id="combo-btn" class="combo-arrow" onclick="handleComboIconClick(event)">â–¼</div>
                                </div>
                                <div id="combobox-list" class="combobox-list"></div>
                            </div>
                        </div>
                        <div class="input-group" style="margin-bottom:20px;">
                            <label>Belt Load Fraction</label>
                            <div class="slider-container">
                                <input type="range" id="beltSlider" min="0" max="100" step="1" oninput="updateFromSlider()">
                                <div id="sliderTicks" class="slider-ticks"></div>
                            </div>
                        </div>
                        <div class="input-group">
                            <label id="rateLabel">Rate (Items/Min)</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustRate(-1)">-1</button>
                                <button class="spinner-btn left" onclick="adjustRate(-0.1)">-0.1</button>
                                <input type="number" id="targetRate" value="60" oninput="calculate()">
                                <button class="spinner-btn right" onclick="adjustRate(0.1)">+0.1</button>
                                <button class="spinner-btn right last" onclick="adjustRate(1)">+1</button>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <h3>Logistics</h3>
                        <div class="input-group">
                            <label>Heat Source</label>
                            <select id="fuelSelect" onchange="updateDefaultButtonState(); calculate();"></select>
                            <input type="checkbox" id="selfFeed" style="display:none;">
                            <div class="split-btn-container">
                                <button id="btnSelfFuel" class="split-btn btn-inactive-red" onclick="toggleFuel()">Self-Fuel: OFF</button>
                                <button id="btnDefFuel" class="split-btn" onclick="setDefaultFuel()">Make Default</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Fertilizer Source</label>
                            <select id="fertSelect" onchange="updateDefaultButtonState(); calculate();"></select>
                            <input type="checkbox" id="selfFert" style="display:none;">
                            <div class="split-btn-container">
                                <button id="btnSelfFert" class="split-btn btn-inactive-red" onclick="toggleFert()">Self-Fert: OFF</button>
                                <button id="btnDefFert" class="split-btn" onclick="setDefaultFert()">Make Default</button>
                            </div>
                        </div>
                        <div class="checkbox-row">
                            <input type="checkbox" id="showMaxCap" onchange="calculate()">
                            <label for="showMaxCap" style="display:inline; margin:0; cursor:pointer;">Show Machine Max Cap</label>
                        </div>
                    </div>
                </div>

                <div id="results-area">
                    <div id="summary-container"></div>
                    <div id="tree"></div>
                </div>

                <div class="panel" solid>
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; margin-bottom:10px; padding-bottom:8px;">
                        <h3 style="margin:0; border:none; padding:0;">Construction List</h3>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span id="build-mode-label" style="font-size:0.8em; color:#ccc; font-weight:bold;">MAX</span>
                            <label class="switch">
                                <input type="checkbox" id="buildModeToggle" onchange="updateBuildModeLabel(); calculate();">
                                <span class="slider-switch"></span>
                            </label>
                        </div>
                    </div>
                    <ul id="construction-list" class="build-list"></ul>
                    <div id="total-mats-container"></div>
                </div>

                <div>
                    <div class="panel">
                        <h3>Upgrades (Levels)</h3>
                        <div class="input-group">
                            <label>Belt Speed</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustInput('lvlBelt', -1); updateFromSlider();">-</button>
                                <input type="number" id="lvlBelt" value="0" min="0" oninput="updateFromSlider()">
                                <button class="spinner-btn right last" onclick="adjustInput('lvlBelt', 1); updateFromSlider();">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Factory Speed</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustInput('lvlSpeed', -1); calculate();">-</button>
                                <input type="number" id="lvlSpeed" value="0" min="0" oninput="calculate()">
                                <button class="spinner-btn right last" onclick="adjustInput('lvlSpeed', 1); calculate();">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Alchemy Skill</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustInput('lvlAlchemy', -1); calculate();">-</button>
                                <input type="number" id="lvlAlchemy" value="0" min="0" oninput="calculate()">
                                <button class="spinner-btn right last" onclick="adjustInput('lvlAlchemy', 1); calculate();">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Fuel Efficiency</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustInput('lvlFuel', -1); calculate();">-</button>
                                <input type="number" id="lvlFuel" value="0" min="0" oninput="calculate()">
                                <button class="spinner-btn right last" onclick="adjustInput('lvlFuel', 1); calculate();">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Fert Efficiency</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustInput('lvlFert', -1); calculate();">-</button>
                                <input type="number" id="lvlFert" value="0" min="0" oninput="calculate()">
                                <button class="spinner-btn right last" onclick="adjustInput('lvlFert', 1); calculate();">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <h3>Save/Reset</h3>
                        <button class="save-btn" onclick="saveSettings()">Save Upgrades</button>
                        <div style="text-align:center; margin-top:15px;">
                            <button class="reset-btn" onclick="resetToDefault()">Factory Reset</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-db" class="view">
            <div class="editor-container">
                <div class="editor-toolbar">
                    <!-- Add a selector to switch between DB and I18N -->
                    <select id="editor-target" onchange="loadEditorContent()" style="width: auto; padding: 5px;">
                        <option value="db">Database</option>
                        <option value="i18n">Translations</option>
                        <option value="db_backup">(BACKUP) Database</option>
                        <option value="i18n_backup">(BACKUP) Translations</option>
                    </select>
                    <button class="save-btn" onclick="applyChanges()" style="width:auto; margin:0;">Apply Changes</button>
                    <button class="info" onclick="exportData()" style="padding:10px; background:var(--info); border:none; color:white; border-radius:4px; font-weight:bold; cursor:pointer;">Export to File</button>
                </div>
                <textarea id="json-editor"></textarea>
            </div>
        </div>
    </main>

<script>
/* ==========================================================================
   SECTION: JS - GLOBAL STATE & INIT
   ========================================================================== */
let DB = null;
const STORAGE_KEY = "alchemy_factory_save_v1";
const SOURCE_KEY = "alchemy_source_v1";
const BACKUP_KEY = "alchemy_source_backup_v1";
const I18N_DATA_KEY = "alchemy_i18n_source_v1";
const I18N_BACKUP_KEY = "alchemy_i18n_source_backup_v1";
let rowCounter = 0; 
let isSelfFuel = false;
let isSelfFert = false;

// RECYCLING STATE
let globalByproducts = {};
let activeRecyclers = {}; // { "path_to_node": true }

// COMBOBOX GLOBALS
let allItemsList = [];
let currentFocus = -1;

function init() {
    const localData = localStorage.getItem(STORAGE_KEY);
    const urlParams = new URLSearchParams(window.location.search);
    const urlItem = urlParams.get('item');
    const urlRate = urlParams.get('rate');
    const urlFuel = urlParams.get('fuel');
    const urlFert = urlParams.get('fert');
    lastUrlItem = urlItem || "";

    if (!window.ALCHEMY_DB) { alert("Error: alchemy_db.js not found!"); }
    if (!window.ALCHEMY_I18N) { alert("Error: alchemy_i18n.js not found!"); }

    const localTranslation = localStorage.getItem(I18N_DATA_KEY);
    if (localTranslation) {
        try {
            console.log("Loading local translation data...");
            window.ALCHEMY_I18N = JSON.parse(localTranslation);
        } catch (e) {
            console.error("Local translation data corrupt, resetting...");
            window.ALCHEMY_I18N = JSON.parse(JSON.stringify(window.ALCHEMY_I18N));
        }
    } else {
        console.log("Loading remote translation data...");
        window.ALCHEMY_I18N = JSON.parse(JSON.stringify(window.ALCHEMY_I18N));
    }

    const fileDB = window.ALCHEMY_DB;
    if (localData) {
        try {
            console.log("Loading local database...");
            DB = JSON.parse(localData);
            const localVersion = DB.version || 0;
            const fileVersion = fileDB.version || 0;

            if (fileVersion != localVersion) {
                console.log(fileVersion);
                showUpdateBanner(localVersion, fileVersion);
            }
        } catch (e) {
            console.error("Local data corrupt, resetting...");
            DB = JSON.parse(JSON.stringify(fileDB));
        }
    } else {
        console.log("Loading remote database...");
        DB = JSON.parse(JSON.stringify(fileDB));
        persist();
    }
    
    if(!DB.items) DB.items = {};
    if(!DB.settings) DB.settings = {};
    if(!DB.settings.preferredRecipes) DB.settings.preferredRecipes = {};
    
    if(DB.settings.activeRecyclers) {
        activeRecyclers = DB.settings.activeRecyclers;
    }

    translateDatabase(DB, true); // Translate DB item key

    prepareComboboxData();
    populateSelects(); 
    loadSettingsToUI();
    renderSlider(); // Initialize the slider logic
    
    if (urlItem) {
        document.getElementById('targetItemInput').value = decodeURIComponent(urlItem);
        updateComboIcon();
    }    
    if (urlRate) {
        document.getElementById('targetRate').disabled = false;
        document.getElementById('targetRate').value = urlRate;
    } else {
        updateFromSlider(); // Apply default slider position
    }
    
    if (urlFuel && document.querySelector(`#fuelSelect option[value="${urlFuel}"]`)) {
        document.getElementById('fuelSelect').value = urlFuel;
    }
    if (urlFert && document.querySelector(`#fertSelect option[value="${urlFert}"]`)) {
        document.getElementById('fertSelect').value = urlFert;
    }
    
    calculate();
}

/* ==========================================================================
   SECTION: JS - SLIDER LOGIC
   ========================================================================== */
function renderSlider() {
    if (typeof BELT_FRACTIONS === 'undefined') {
        console.error("alchemy_constants.js not loaded.");
        return;
    }
    const slider = document.getElementById('beltSlider');
    const ticksContainer = document.getElementById('sliderTicks');
    const thumbWidth = 14; // Must match CSS --thumb-size
    
    // Set slider max to array length
    slider.max = BELT_FRACTIONS.length - 1;
    slider.value = BELT_FRACTIONS.length - 1; // Default to Full
    
    ticksContainer.innerHTML = '';
    
    BELT_FRACTIONS.forEach((frac, idx) => {
        const pct = (idx / (BELT_FRACTIONS.length - 1));
        
        // --- ALIGNMENT MATH ---
        // Range Input Logic: Thumb center moves from [ThumbWidth/2] to [Width - ThumbWidth/2]
        // This formula nudges the ticks inward based on percentage to align with center
        const leftPos = `calc(${pct * 100}% + (${(thumbWidth/2) - (thumbWidth * pct) + 2}px))`;
        
        const tick = document.createElement('div');
        tick.className = `tick-mark ${frac.label ? 'labeled' : ''}`;
        tick.style.left = leftPos;
        
        let labelHtml = '';
        if (frac.label) {
            if (frac.label === "Full") {
                labelHtml = `<div class="vertical-frac full-label">Full</div>`;
            } else if (frac.label.includes("/")) {
                const [n, d] = frac.label.split("/");
                labelHtml = `
                    <div class="vertical-frac">
                        <span class="num">${n}</span>
                        <span class="sep"></span>
                        <span class="den">${d}</span>
                    </div>`;
            } else {
                labelHtml = `<div class="vertical-frac">${frac.label}</div>`;
            }
        }
        
        tick.innerHTML = `<div class="tick-line"></div>${labelHtml}`;
        ticksContainer.appendChild(tick);
    });
}

function updateFromSlider() {
    if (typeof BELT_FRACTIONS === 'undefined') return;
    
    const sliderIndex = parseInt(document.getElementById('beltSlider').value);
    const fraction = BELT_FRACTIONS[sliderIndex];
    const lvlBelt = parseInt(document.getElementById('lvlBelt').value) || 0;
    const currentSpeed = getBeltSpeed(lvlBelt);
    
    const rate = calculateRateFromFraction(fraction, currentSpeed);
    
    // Update the input box
    const rateInput = document.getElementById('targetRate');
    rateInput.value = parseFloat(rate.toFixed(2));
    
    calculate();
}

/* ==========================================================================
   SECTION: JS - EDITOR & DATA MANAGEMENT
   ========================================================================== */
function loadEditorContent() {
    const target = document.getElementById('editor-target').value;
    const editor = document.getElementById('json-editor');

    switch (target) {
        case 'db': editor.value = localStorage.getItem(SOURCE_KEY) ?? JSON.stringify(DB, null, 2); break;
        case 'db_backup': editor.value = localStorage.getItem(BACKUP_KEY) ?? ""; break;
        case 'i18n': editor.value = JSON.stringify(window.ALCHEMY_I18N, null, 2); break;
        case 'i18n_backup': editor.value = localStorage.getItem(I18N_BACKUP_KEY) ?? ""; break;
    }
}

function applyChanges() {
    const txt = document.getElementById('json-editor').value;
    const target = document.getElementById('editor-target').value;
    try {
        const jsonMatch = txt.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error("Format error: No valid JSON found (missing { ... })");
        
        let jsonString = jsonMatch[0];
        jsonString = jsonString.replace(/\/\/.*$/gm, '');
        const parsedData = JSON.parse(jsonString); // Avoid using eval()

        switch (target) {
            case 'db': 
            case 'db_backup': 
                window.ALCHEMY_DB = parsedData;
                DB = window.ALCHEMY_DB;
                if (localStorage.getItem(SOURCE_KEY)) localStorage.setItem(BACKUP_KEY, localStorage.getItem(SOURCE_KEY));
                localStorage.setItem(SOURCE_KEY, txt);
                persist();
                init();
            case 'i18n':
            case 'i18n_backup':                
                translateDatabase(DB, false); // Revert DB item key back the the original key
                window.ALCHEMY_I18N = parsedData;
                if (localStorage.getItem(I18N_DATA_KEY)) localStorage.setItem(I18N_BACKUP_KEY, localStorage.getItem(I18N_DATA_KEY));
                localStorage.setItem(I18N_DATA_KEY, JSON.stringify(window.ALCHEMY_I18N));
                location.reload();
        }        
        alert("Applied " + (target === 'db' || target === 'db_backup' ? "Database" : "Translations") + " safely!");
    } catch(e) {
        alert("JSON Parsing Error: " + e.message + "\n\nNote: Please ensure the data uses double quotes and no trailing commas.");
    }
}

function showUpdateBanner(oldV, newV) {
    const banner = document.getElementById('update-banner');
    banner.style.display = 'flex';
    document.getElementById('old-version-id').innerText = 'v' + oldV;
    document.getElementById('new-version-id').innerText = 'v' + newV;
    document.getElementById('ui-update-msg').innerText = t('New database version available', 'ui');
    document.getElementById('ui-update-local-msg').innerText = t('Current local version:', 'ui');
    document.getElementById('ui-btn-update').innerText = t('Update Now', 'ui');
    document.getElementById('ui-btn-later').innerText = t('Skip Update', 'ui');   
}

function closeUpdateBanner() {
    document.getElementById('update-banner').style.display = 'none';
    console.log("Bump local data version to " + window.ALCHEMY_DB.version);
    DB.version = window.ALCHEMY_DB.version;
    persist();
}

function performUpdate() {
    console.log("Updating database v" + window.ALCHEMY_DB.version);    
    const newData = JSON.parse(JSON.stringify(window.ALCHEMY_DB));
    if (DB && DB.settings) {
        newData.settings = DB.settings;
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(newData));
    const localSourceData = localStorage.getItem(SOURCE_KEY);
    if (localSourceData) {
        localStorage.setItem(BACKUP_KEY, localSourceData);
    }
    localStorage.removeItem(SOURCE_KEY);
    location.reload();
}

function exportData() {
    const txt = document.getElementById('json-editor').value; const blob = new Blob([txt], { type: "text/javascript" });
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = "alchemy_db.js"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

function persist() { 
    DB.settings.activeRecyclers = activeRecyclers;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(DB)); 
}

/* ==========================================================================
   SECTION: JS - COMBOBOX LOGIC
   ========================================================================== */
function prepareComboboxData() {
    const allItems = new Set(Object.keys(DB.items || {}));
    if(DB.recipes) DB.recipes.forEach(r => Object.keys(r.outputs).forEach(k => allItems.add(k)));
    allItemsList = Array.from(allItems).sort().map(name => {
        return { name: name, category: t((DB.items[name] ? DB.items[name].category : "Other"), 'categories') };
    });
}

function toggleCombobox() {
    const list = document.getElementById('combobox-list');
    const input = document.getElementById('targetItemInput');
    if(list.style.display === 'block') { closeCombobox(); } else { input.focus(); filterCombobox(); }
}

function updateComboIcon() {
    const input = document.getElementById('targetItemInput');
    const icon = document.getElementById('combo-btn');
    if(input.value.trim().length > 0) {
        icon.innerText = "âœ–";
        icon.style.color = "#ff5252";
    } else {
        icon.innerText = "â–¼";
        icon.style.color = "#888";
    }
}

function handleComboIconClick(e) {
    e.stopPropagation();
    const input = document.getElementById('targetItemInput');
    if(input.value.trim().length > 0) {
        input.value = "";
        filterCombobox();
        updateComboIcon();
        input.focus();
    } else {
        toggleCombobox();
    }
}

function closeCombobox() { document.getElementById('combobox-list').style.display = 'none'; currentFocus = -1; }
function closeComboboxDelayed() { setTimeout(() => closeCombobox(), 200); }

function filterCombobox() {
    const input = document.getElementById('targetItemInput');
    const filter = input.value.toLowerCase();
    const list = document.getElementById('combobox-list');
    const ghost = document.getElementById('ghost-text');
    
    list.innerHTML = ''; list.style.display = 'block';
    updateComboIcon();
    
    let matches = allItemsList.filter(item => item.name.toLowerCase().includes(filter));
    matches.sort((a, b) => {
        const aStarts = a.name.toLowerCase().startsWith(filter);
        const bStarts = b.name.toLowerCase().startsWith(filter);
        if (aStarts && !bStarts) return -1;
        if (!aStarts && bStarts) return 1;
        return a.name.localeCompare(b.name);
    });

    matches.forEach((item) => {
        const div = document.createElement('div'); div.className = 'combo-item';
        div.innerHTML = `<span>${item.name}</span> <span class="combo-cat">${item.category}</span>`;
        div.onclick = function() { selectItem(item.name); };
        list.appendChild(div);
    });

    if (filter.length > 0 && matches.length > 0) {
        const topMatch = matches[0].name;
        if (topMatch.toLowerCase().startsWith(filter)) {
            const ghostSuffix = topMatch.substring(filter.length);
            ghost.innerText = input.value + ghostSuffix;
        } else { ghost.innerText = ""; }
    } else { ghost.innerText = ""; }
}

function handleComboKey(e) {
    const list = document.getElementById('combobox-list');
    const items = list.getElementsByClassName('combo-item');
    const input = document.getElementById('targetItemInput');
    const ghost = document.getElementById('ghost-text');

    if (e.key === 'ArrowDown') {
        currentFocus++; if (currentFocus >= items.length) currentFocus = 0; setActive(items); e.preventDefault();
    } else if (e.key === 'ArrowUp') {
        currentFocus--; if (currentFocus < 0) currentFocus = items.length - 1; setActive(items); e.preventDefault();
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (currentFocus > -1 && items.length > 0) { items[currentFocus].click(); } 
        else if (ghost.innerText.length > input.value.length) { selectItem(ghost.innerText); } 
        else if (items.length > 0) { items[0].click(); } 
        else { closeCombobox(); calculate(); }
    } else if (e.key === 'Tab') {
        if (ghost.innerText.length > input.value.length) { e.preventDefault(); selectItem(ghost.innerText); } 
        else { closeCombobox(); }
    }
}

function setActive(items) {
    if (!items) return;
    for (let i = 0; i < items.length; i++) { items[i].classList.remove('selected'); }
    if (currentFocus >= 0 && currentFocus < items.length) {
        items[currentFocus].classList.add('selected'); items[currentFocus].scrollIntoView({ block: 'nearest' });
        const name = items[currentFocus].getElementsByTagName('span')[0].innerText;
        document.getElementById('targetItemInput').value = name;
        document.getElementById('ghost-text').innerText = "";
        updateComboIcon();
    }
}

function selectItem(name) {
    const input = document.getElementById('targetItemInput'); input.value = name;
    document.getElementById('ghost-text').innerText = ""; closeCombobox(); updateComboIcon(); updateFromSlider(); 
}

/* ==========================================================================
   SECTION: JS - UI HANDLERS (INPUTS/SETTINGS)
   ========================================================================== */
function loadSettingsToUI() {
    if (DB.settings) {
        ['lvlBelt','lvlSpeed','lvlAlchemy','lvlFuel','lvlFert'].forEach(k => { if(DB.settings[k] !== undefined) document.getElementById(k).value = DB.settings[k]; });
        if(DB.settings.defaultFuel) document.getElementById('fuelSelect').value = DB.settings.defaultFuel; 
        if(DB.settings.defaultFert) document.getElementById('fertSelect').value = DB.settings.defaultFert; 
    }
    updateDefaultButtonState();
}

function populateSelects() {
    const fuelSel = document.getElementById('fuelSelect'); const fertSel = document.getElementById('fertSelect');
    fuelSel.innerHTML = ''; fertSel.innerHTML = '';
    const fuels = []; const ferts = [];
    const allItems = new Set(Object.keys(DB.items || {}));
    if(DB.recipes) DB.recipes.forEach(r => Object.keys(r.outputs).forEach(k => allItems.add(k)));

    allItems.forEach(itemName => {
        const itemDef = DB.items[itemName] || {};
        if(itemDef.heat) fuels.push({ name: itemName, heat: itemDef.heat });
        if(itemDef.nutrientValue) ferts.push({ name: itemName, val: itemDef.nutrientValue });
    });

    fuels.sort((a,b) => b.heat - a.heat).forEach(f => { fuelSel.appendChild(new Option(`${f.name} (${f.heat} P)`, f.name)); });
    ferts.sort((a,b) => b.val - a.val).forEach(f => { fertSel.appendChild(new Option(`${f.name} (${f.val} V)`, f.name)); });
}

function toggleFuel() {
    const btn = document.getElementById('btnSelfFuel'); const chk = document.getElementById('selfFeed');
    chk.checked = !chk.checked;
    if(chk.checked) { btn.innerText = "Self-Fuel: ON"; btn.classList.remove('btn-inactive-red'); btn.classList.add('btn-active-green'); } 
    else { btn.innerText = "Self-Fuel: OFF"; btn.classList.remove('btn-active-green'); btn.classList.add('btn-inactive-red'); }
    calculate();
}

function toggleFert() {
    const btn = document.getElementById('btnSelfFert'); const chk = document.getElementById('selfFert');
    chk.checked = !chk.checked;
    if(chk.checked) { btn.innerText = "Self-Fert: ON"; btn.classList.remove('btn-inactive-red'); btn.classList.add('btn-active-green'); } 
    else { btn.innerText = "Self-Fert: OFF"; btn.classList.remove('btn-active-green'); btn.classList.add('btn-inactive-red'); }
    calculate();
}

function setDefaultFuel() { const c = document.getElementById('fuelSelect').value; DB.settings.defaultFuel = c; persist(); updateDefaultButtonState(); alert("Default Fuel Saved: " + c); }
function setDefaultFert() { const c = document.getElementById('fertSelect').value; DB.settings.defaultFert = c; persist(); updateDefaultButtonState(); alert("Default Fertilizer Saved: " + c); }

function updateDefaultButtonState() {
    const curFuel = document.getElementById('fuelSelect').value; const defFuel = DB.settings.defaultFuel;
    const btnFuel = document.getElementById('btnDefFuel');
    if(curFuel === defFuel) { btnFuel.disabled = true; btnFuel.innerText = "Current Default"; } else { btnFuel.disabled = false; btnFuel.innerText = "Make Default"; }

    const curFert = document.getElementById('fertSelect').value; const defFert = DB.settings.defaultFert;
    const btnFert = document.getElementById('btnDefFert');
    if(curFert === defFert) { btnFert.disabled = true; btnFert.innerText = "Current Default"; } else { btnFert.disabled = false; btnFert.innerText = "Make Default"; }
}

function saveSettings() { ['lvlBelt','lvlSpeed','lvlAlchemy','lvlFuel','lvlFert'].forEach(k => { DB.settings[k] = parseInt(document.getElementById(k).value) || 0; }); persist(); alert("Settings Saved!"); }
function resetToDefault() {
    if(confirm(t('Reset All Database?', 'ui'))) {
        console.log("Reset All Database");
        const localSourceData = localStorage.getItem(SOURCE_KEY);
        const localSourceI18NData = localStorage.getItem(I18N_DATA_KEY);
        localStorage.clear();
        if (localSourceData) localStorage.setItem(BACKUP_KEY, localSourceData);
        if (localSourceI18NData) localStorage.setItem(I18N_BACKUP_KEY, localSourceI18NData);
        location.reload();
    } 
}


let pickerCollapsedStates = {}; //Global state to remember which categories are collapsed during the current session

/**
 * Opens the item picker modal and populates it with categorized items.
 */
function openItemPicker() {
    const body = document.getElementById('picker-body');
    body.innerHTML = ''; 

    const categories = {};
    const itemKeys = Object.keys(DB.items);
    const currentItem = document.getElementById('targetItemInput').value;

    // Grouping logic
    itemKeys.forEach(key => {
        const item = DB.items[key];
        const cat = item.category || "Other";
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push({ name: key, ...item });
    });

    Object.keys(categories).forEach(catName => {
        const catContainer = document.createElement('div');
        catContainer.className = 'picker-category';
        
        // Restore collapse state from memory (default to expanded if undefined)
        if (pickerCollapsedStates[catName] === true) {
            catContainer.classList.add('collapsed');
        }

        const translatedCat = t(catName, 'categories');
        
        const header = document.createElement('div');
        header.className = 'picker-cat-header';
        header.innerHTML = `<span>${translatedCat} (${categories[catName].length})</span> <span class="arrow">â–¼</span>`;
        
        header.onclick = () => {
            const isCollapsed = catContainer.classList.toggle('collapsed');
            // Save state to session memory
            pickerCollapsedStates[catName] = isCollapsed;
        };
        
        const grid = document.createElement('div');
        grid.className = 'picker-grid';
        
        categories[catName].forEach(item => {
            const itemBtn = document.createElement('div');
            itemBtn.className = 'picker-item' + (item.name === currentItem ? ' active' : '');
            itemBtn.innerHTML = `<span>${item.name}</span>`;
            itemBtn.onclick = (e) => {
                e.stopPropagation(); // Prevent trigger header toggle
                selectItem(item.name);
                closeModal('picker-modal');
            };
            grid.appendChild(itemBtn);
        });

        catContainer.appendChild(header);
        catContainer.appendChild(grid);
        body.appendChild(catContainer);
    });

    document.getElementById('ui-picker-title').innerText = t('Select Target Item', 'ui');
    document.getElementById('ui-picker-expand-all').innerText = t('Expand All', 'ui');
    document.getElementById('ui-picker-collapse-all').innerText = t('Collapse All', 'ui');
    document.getElementById('picker-modal').style.display = 'flex';
}

/**
 * Expand or Collapse all categories at once
 * @param {boolean} shouldCollapse 
 */
function toggleAllCategories(shouldCollapse) {
    const categories = document.querySelectorAll('.picker-category');
    categories.forEach(el => {
        if (shouldCollapse) el.classList.add('collapsed');
        else el.classList.remove('collapsed');
    });

    // Update all states in memory
    const catNames = Object.keys(pickerCollapsedStates);
    // If memory is empty, find names from the data
    const targetNames = catNames.length > 0 ? catNames : Array.from(new Set(Object.values(DB.items).map(i => i.category)));
    
    targetNames.forEach(name => {
        pickerCollapsedStates[name] = shouldCollapse;
    });
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function showChangelog() { document.getElementById('changelog-modal').style.display = 'flex'; }
function switchTab(tabName) {
    document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('view-' + tabName).classList.add('active');
    const btnIndex = tabName === 'calc' ? 0 : 1;
    document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
}

function adjustInput(id, delta) { const el = document.getElementById(id); let val = parseInt(el.value) || 0; el.value = Math.max(0, val + delta); }
function adjustRate(delta) { 
    const el = document.getElementById('targetRate'); 
    if(el.disabled) return; 
    let val = parseFloat(el.value) || 0; 
    // Fix floating point errors (e.g. 0.1 + 0.2 = 0.300000004)
    el.value = (Math.round((val + delta) * 10) / 10).toFixed(1); 
    calculate(); 
}

/* ==========================================================================
   SECTION: JS - RECIPE MODAL LOGIC
   ========================================================================== */
function openRecipeModal(item, domElement) {
    const candidates = getRecipesFor(item);
    const list = document.getElementById('recipe-list');
    list.innerHTML = '';
    document.getElementById('recipe-modal-title').innerText = t('Select Recipe for ') + item;
    const currentId = (getActiveRecipe(item) || {}).id;
    
    let ancestors = [];
    if (domElement && domElement.dataset.ancestors) {
        try { ancestors = JSON.parse(domElement.dataset.ancestors); } catch(e) {}
    }

    candidates.forEach(r => {
        const div = document.createElement('div');
        div.className = `recipe-option ${r.id === currentId ? 'active' : ''}`;
        
        let isLoop = false; let conflict = "";
        if (r.inputs) {
            for (let inp in r.inputs) {
                if (inp === item || ancestors.includes(inp)) { isLoop = true; conflict = inp; break; }
            }
        }
        if (!isLoop && r.outputs) {
            for (let out in r.outputs) {
                if (out !== item && ancestors.includes(out)) { isLoop = true; conflict = out; break; }
            }
        }

        let inputs = []; Object.keys(r.inputs).forEach(key => { inputs.push(`${r.inputs[key]}x ${key}`); });
        let outputs = []; Object.keys(r.outputs).forEach(key => { outputs.push(`${r.outputs[key]}x ${key}`); });

        let content = `
            <div class="recipe-header"><strong>${t(r.machine, 'machines')}</strong> <span style="font-size:0.9em; opacity:0.8;">(${r.baseTime}s)</span>${r.id === currentId ? 'âœ…' : ''}</div>
            <div class="recipe-details">${t('Input')}: ${inputs.join(', ')}<br>${t('Yields')}: ${outputs.join(', ')}</div>
        `;

        if (isLoop) {
            div.classList.add("disabled");
            content += `<div class="loop-warning">âš ï¸ Creates Infinite Loop with ${conflict}</div>`;
            div.onclick = () => alert(`Cannot select this recipe. It creates a recursive loop because it depends on or outputs ${conflict}, which is already being produced in this chain.`);
        } else {
            div.onclick = () => { DB.settings.preferredRecipes[item] = r.id; persist(); closeModal('recipe-modal'); calculate(); };
        }

        div.innerHTML = content;
        list.appendChild(div);
    });
    document.getElementById('recipe-modal').style.display = 'flex';
}

function openDrillDown(item, rate) {
    const url = `index.html?item=${encodeURIComponent(item)}&rate=${rate.toFixed(2)}`;
    window.open(url, '_blank');
}

function switchTab(tabName) {
    document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('view-' + tabName).classList.add('active');
    if (tabName === 'db') {
        const editor = document.getElementById('json-editor');
        if (editor.value.trim() === "") {
            loadEditorContent();
        }
    }
    const btnIndex = tabName === 'calc' ? 0 : 1;
    document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
}

function adjustInput(id, delta) { const el = document.getElementById(id); let val = parseInt(el.value) || 0; el.value = Math.max(0, val + delta); }
function adjustRate(delta) { const el = document.getElementById('targetRate'); if(el.disabled) return; let val = parseFloat(el.value) || 0; el.value = (val + delta).toFixed(1); calculate(); }

/* ==========================================================================
   SECTION: JS - HELPER FUNCTIONS
   ========================================================================== */
function getBeltSpeed(lvl) { let s = 60; if(lvl>0) s += Math.min(lvl,12)*15; if(lvl>12) s += (lvl-12)*3; return s; }
function getSpeedMult(lvl) { let m = 1.0; m += Math.min(lvl,12)*0.25; if(lvl>12) m += (lvl-12)*0.05; return m; }
function getAlchemyMult(lvl) { if(lvl<=0) return 1.0; let p = 0; for(let i=1; i<=lvl; i++) { if(i<=2) p+=6; else if(i<=8) p+=8; else p+=10; } return 1.0 + (p/100); }

function getRecipesFor(item) { if(!DB.recipes) return []; return DB.recipes.filter(r => r.outputs[item]); }
function getActiveRecipe(item) {
    const candidates = getRecipesFor(item);
    if(candidates.length === 0) return null; if(candidates.length === 1) return candidates[0];
    const prefId = DB.settings.preferredRecipes[item];
    if(prefId) { const found = candidates.find(r => r.id === prefId); if(found) return found; }
    return candidates[0];
}

function getProductionHeatCost(item, speedMult, alchemyMult) {
    let cost = 0; const recipe = getActiveRecipe(item);
    if (recipe && recipe.outputs[item]) {
         let batchYield = recipe.outputs[item];
         if (recipe.machine === "Extractor" || recipe.machine === "Alembic") batchYield *= alchemyMult;
         if (DB.machines[recipe.machine] && DB.machines[recipe.machine].heatCost) {
            const mach = DB.machines[recipe.machine]; const parent = DB.machines[mach.parent];
            const slotsReq = mach.slotsRequired || 1; const pSlots = mach.parentSlots || parent.slots || 3;
            const heatPs = (mach.heatCost * speedMult) + (parent.heatSelf / (pSlots/slotsReq)); 
            cost += heatPs * ((recipe.baseTime / speedMult) / batchYield);
        }
        Object.keys(recipe.inputs).forEach(k => { 
            cost += getProductionHeatCost(k, speedMult, alchemyMult) * (recipe.inputs[k] / batchYield); 
        });
    }
    return cost;
}

function getProductionFertCost(item, fertVal, fertSpeed, speedMult, alchemyMult) {
    let cost = 0; const itemDef = DB.items[item] || {};
    if (itemDef.category === "Herbs" && itemDef.nutrientCost) cost += itemDef.nutrientCost;
    const recipe = getActiveRecipe(item);
    if (recipe && recipe.outputs[item]) {
        let batchYield = recipe.outputs[item];
        if (recipe.machine === "Extractor" || recipe.machine === "Alembic") batchYield *= alchemyMult;
        Object.keys(recipe.inputs).forEach(k => { 
            cost += getProductionFertCost(k, fertVal, fertSpeed, speedMult, alchemyMult) * (recipe.inputs[k] / batchYield); 
        });
    }
    return cost;
}

function formatVal(val) { if(val >= 1000000) return (val/1000000).toFixed(2) + 'm'; if(val >= 10000) return (val/1000).toFixed(2) + 'k'; return val.toFixed(2); }

function toggleBuildGroup(header) {
    header.classList.toggle('expanded');
}

function toggleNode(arrowElement) {
    const node = arrowElement.closest('.node');
    if (node) node.classList.toggle('collapsed');
}

function toggleRecycle(pathKey) {
    if (activeRecyclers[pathKey]) {
        delete activeRecyclers[pathKey];
    } else {
        activeRecyclers[pathKey] = true;
    }
    persist();
    calculate();
}

/* ==========================================================================
   SECTION: JS - CALCULATION ENGINE
   ========================================================================== */
function calculate() {
    try {
        if(!DB || !DB.recipes) return;
        
        // 1. Gather Inputs
        let rawInput = document.getElementById('targetItemInput').value.trim();
        let targetItem = Object.keys(DB.items).find(k => k.toLowerCase() === rawInput.toLowerCase()) || rawInput;
        const targetRate = parseFloat(document.getElementById('targetRate').value) || 0;
        
        // Settings
        const selectedFuel = document.getElementById('fuelSelect').value; const selfFeed = document.getElementById('selfFeed').checked;
        const selectedFert = document.getElementById('fertSelect').value; const selfFert = document.getElementById('selfFert').checked;
        const showMax = document.getElementById('showMaxCap').checked;
        const lvlSpeed = parseInt(document.getElementById('lvlSpeed').value) || 0;
        const lvlBelt = parseInt(document.getElementById('lvlBelt').value) || 0;
        const lvlFuel = parseInt(document.getElementById('lvlFuel').value) || 0;
        const lvlAlchemy = parseInt(document.getElementById('lvlAlchemy').value) || 0;
        const lvlFert = parseInt(document.getElementById('lvlFert').value) || 0;
        
        const params = {
            targetItem, targetRate, selectedFuel, selfFeed, selectedFert, selfFert, showMax,
            lvlSpeed, lvlBelt, lvlFuel, lvlAlchemy, lvlFert,
            speedMult: getSpeedMult(lvlSpeed),
            alchemyMult: getAlchemyMult(lvlAlchemy),
            fuelMult: 1 + (lvlFuel * 0.10),
            fertMult: 1 + (lvlFert * 0.10),
            beltSpeed: getBeltSpeed(lvlBelt)
        };

        // --- UPDATE SMART LABEL (v92) ---
        if (typeof getSmartLabel === 'function') {
            const lbl = getSmartLabel(targetRate, params.beltSpeed);
            document.getElementById('rateLabel').innerText = `${t('Rate (Items/Min)')}: ${lbl}`;
        }

        // --- PASS 1: GHOST CALCULATION (Find Byproducts) ---
        globalByproducts = {}; 
        calculatePass(params, true); // True = Ghost Mode (No DOM, just Byproducts)

        // --- PASS 2: RENDER ---
        rowCounter = 0;
        document.getElementById('tree').innerHTML = '';
        calculatePass(params, false); // False = Render Mode

        // --- PASS 3: TRANSLATION --- (extra)
        translateText();
        updateURL();

    } catch(e) { console.error(e); }
}

function translateText() {
    const selectors = [
        '.panel h3', '.section-header',
        '.input-group label', '.checkbox-row label', '.stat-label',
        '.tab-btn', '.split-btn', '.save-btn', '.reset-btn', '.info'
    ].join(',');

    document.querySelectorAll(selectors).forEach(el => {
        const key = el.textContent.trim();
        el.textContent = t(key, 'ui');
    });

    const input = document.getElementById('targetItemInput');
    if (input) input.placeholder = t("Select or Type...", "ui");
}

let lastUrlItem = ""; 
let isHandlingPopstate = false;

function updateURL() {
    const item = document.getElementById('targetItemInput').value;
    const rate = document.getElementById('targetRate').value;
    const fuel = document.getElementById('fuelSelect').value;
    const fert = document.getElementById('fertSelect').value;
    
    const params = new URLSearchParams();
    if (item) params.set('item', item);
    if (rate) params.set('rate', Number(rate));
    // Maybe enable in future if user needs?
    //if (fuel) params.set('fuel', fuel);
    //if (fert) params.set('fert', fert);

    const newUrl = window.location.pathname + '?' + params.toString();
    if (isHandlingPopstate || item == lastUrlItem) {        
        window.history.replaceState(null, '', newUrl);
    }
    else {
        window.history.pushState(null, '', newUrl);
        lastUrlItem = item;
    }
}

window.addEventListener('popstate', function(event) {
    isHandlingPopstate = true;
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('item')) {
        document.getElementById('targetItemInput').value = urlParams.get('item');
        if (urlParams.has('rate')) document.getElementById('targetRate').value = urlParams.get('rate');
        if (urlParams.has('fuel')) document.getElementById('fuelSelect').value = urlParams.get('fuel');
        if (urlParams.has('fert')) document.getElementById('fertSelect').value = urlParams.get('fert');
        calculate(); 
    }
    isHandlingPopstate = false;
});


function calculatePass(p, isGhost) {
    // Re-calc basic inputs derived from params
    const fuelDef = DB.items[p.selectedFuel] || {};
    let netFuelEnergy = (fuelDef.heat || 10) * p.fuelMult; const grossFuelEnergy = netFuelEnergy; 
    if (p.selfFeed) { netFuelEnergy -= getProductionHeatCost(p.selectedFuel, p.speedMult, p.alchemyMult); }
    if(netFuelEnergy <= 0) netFuelEnergy = 0.1; 

    const fertDef = DB.items[p.selectedFert] || { nutrientValue: 144, maxFertility: 12 };
    let netFertVal = fertDef.nutrientValue * p.fertMult; const grossFertVal = netFertVal;
    if (p.selfFert) { netFertVal -= getProductionFertCost(p.selectedFert, netFertVal, fertDef.maxFertility, p.speedMult, p.alchemyMult); }
    if(netFertVal <= 0) netFertVal = 0.1;

    let globalFuelDemandItems = 0; let globalFertDemandItems = 0; let globalHeatLoad = 0; let globalBioLoad = 0; let globalCostPerMin = 0;
    let totalByproducts = {};

    // --- AGGREGATION STRUCTURES ---
    let machineStats = {};
    let furnaceSlotDemand = {}; 

    function addMachineCount(machineName, outputItem, countMax, countRaw) {
        if (!machineStats[machineName]) machineStats[machineName] = {};
        if (!machineStats[machineName][outputItem]) machineStats[machineName][outputItem] = { rawFloat: 0, nodeSumInt: 0 };
        machineStats[machineName][outputItem].rawFloat += countRaw;
        machineStats[machineName][outputItem].nodeSumInt += countMax;
    }

    let grossRate = p.targetRate;
    if (p.selfFeed && p.targetItem === p.selectedFuel) { grossRate = p.targetRate * (grossFuelEnergy / netFuelEnergy); }
    if (p.selfFert && p.targetItem === p.selectedFert) { grossRate = p.targetRate * (grossFertVal / netFertVal); }

    const treeContainer = document.getElementById('tree');

    // Recursive Builder
    function buildNode(item, rate, isInternalModule, ancestors = [], forceGhost = false) {
        const effectiveGhost = isGhost || forceGhost;

        // RECYCLING CHECK
        let deduction = 0;
        let pathKey = ancestors.join(">") + ">" + item;
        let canRecycle = false;
        
        if (!effectiveGhost) {
            if (globalByproducts[item] && globalByproducts[item] > 0.01) {
                canRecycle = true;
                if (activeRecyclers[pathKey]) {
                    deduction = Math.min(rate, globalByproducts[item]);
                    globalByproducts[item] -= deduction; 
                }
            }
        }

        const netRate = Math.max(0, rate - deduction);
        const itemDef = DB.items[item] || {}; 
        let ingredientChildren = []; 
        let currentPath = [...ancestors, item];
        let myRowID = 0;
        
        if (!effectiveGhost) { rowCounter++; myRowID = rowCounter; }

        let outputTag = ""; let machineTag = ""; let heatTag = ""; let swapBtn = ""; 
        let bioTag = ""; let costTag = ""; let detailsTag = ""; let recycleTag = "";
        let machinesNeeded = 0; let hasChildren = false;

        let isFuel = (item === p.selectedFuel); let isFert = (item === p.selectedFert);
        if(isFuel) { outputTag = `<span class="output-tag">Output: ${formatVal((rate * (fuelDef.heat||10)*p.fuelMult)/60)} P/s</span>`; }
        else if (isFert) { outputTag = `<span class="output-tag">Output: ${formatVal((rate * fertDef.nutrientValue*p.fertMult)/60)} V/s</span>`; }

        // --- RECYCLE UI ---
        if (canRecycle && !effectiveGhost) {
            if (activeRecyclers[pathKey]) {
                let activeClass = "active";
                let label = `â™»ï¸ ${formatVal(deduction)} ${t('Used')}`;
                recycleTag = `<div class="push-right"><button class="recycle-btn ${activeClass}" onclick="toggleRecycle('${pathKey}')">${label}</button></div>`;
            } else {
                let label = `â™»ï¸ ${formatVal(globalByproducts[item])} ${t('Avail')}`;
                recycleTag = `<div class="push-right"><button class="recycle-btn" onclick="toggleRecycle('${pathKey}')">${label}</button></div>`;
            }
        }

        // Logic branching based on Item Type
        if (itemDef.category === "Herbs" && itemDef.nutrientCost) {
            // Nursery Logic
            const fertilitySpeed = (fertDef.maxFertility || 12); const timePerItem = itemDef.nutrientCost / fertilitySpeed; 
            const calculatedSpeed = (60 / timePerItem) * p.speedMult; 
            const isLiquid = (itemDef.liquid === true);
            const itemsPerMinPerMachine = isLiquid ? calculatedSpeed : Math.min(calculatedSpeed, p.beltSpeed);
            
            machinesNeeded = netRate / itemsPerMinPerMachine;
            if (Math.abs(Math.round(machinesNeeded) - machinesNeeded) < 0.0001) { machinesNeeded = Math.round(machinesNeeded); }

            if(!effectiveGhost) {
                addMachineCount("Nursery", item, Math.ceil(machinesNeeded - 0.0001), machinesNeeded);
            }

            const totalNutrientsNeeded = netRate * itemDef.nutrientCost; const itemsNeeded = totalNutrientsNeeded / grossFertVal; 
            
            // FIX: Always track Global Load (Fixes Summary Box)
            if (effectiveGhost || !isInternalModule || isInternalModule) {
                globalFertDemandItems += itemsNeeded; 
                globalBioLoad += (totalNutrientsNeeded / 60); 
            }
            
            if(!effectiveGhost) {
                let tooltipText = `Recipe: ${item} (Nursery)\nBase Time: ${(timePerItem * (60/p.speedMult)).toFixed(1)}s\nSpeed Mult: ${p.speedMult.toFixed(2)}x\nThroughput: ${itemsPerMinPerMachine.toFixed(2)} items/min`;
                let capTag = "";
                if(p.showMax) {
                    const maxOutput = Math.ceil(machinesNeeded) * itemsPerMinPerMachine;
                    capTag = `<span class="max-cap-tag">(Max: ${formatVal(maxOutput)}/m)</span>`;
                }
                machineTag = `<span class="machine-tag" title="${tooltipText}">${Math.ceil(machinesNeeded)} ${t('Nursery', 'machines')}${capTag}</span>`;
                bioTag = `<span class="bio-tag">${formatVal(netRate * itemDef.nutrientCost / 60)} V/s ( ${(netRate * itemDef.nutrientCost / grossFertVal).toFixed(1)}/m ${p.selectedFert} )</span>`;
            }
        } 
        else {
            const recipe = getActiveRecipe(item);
            if (!recipe) {
                if(!effectiveGhost) {
                    if(itemDef.buyPrice) { 
                        let c = netRate * itemDef.buyPrice; 
                        globalCostPerMin += c; 
                        costTag = `<span class="cost-tag">${Math.ceil(c).toLocaleString()} G/m</span>`; 
                    }
                    detailsTag = `<span class="details">(${t('Raw Input')})</span>`;
                }
            } else {
                hasChildren = true;
                let batchYield = recipe.outputs[item] || 1;
                if (recipe.machine === "Extractor" || recipe.machine === "Alembic") batchYield *= p.alchemyMult;
                
                const batchesPerMin = netRate / batchYield;
                const maxBatchesPerMin = (60 / recipe.baseTime) * p.speedMult;
                const isLiquid = (itemDef.liquid === true);
                let effectiveBatchesPerMin = maxBatchesPerMin;
                
                if (!isLiquid) {
                    const maxItemsPerMin = maxBatchesPerMin * batchYield;
                    if (maxItemsPerMin > p.beltSpeed) { effectiveBatchesPerMin = p.beltSpeed / batchYield; }
                }
                
                let rawMachines = batchesPerMin / effectiveBatchesPerMin;
                if (Math.abs(Math.round(rawMachines) - rawMachines) < 0.0001) { rawMachines = Math.round(rawMachines); }
                machinesNeeded = rawMachines;
                
                Object.keys(recipe.outputs).forEach(outKey => {
                    if (outKey !== item) {
                        let yieldPerBatch = recipe.outputs[outKey];
                        let totalByproduct = batchesPerMin * yieldPerBatch; 
                        
                        if(effectiveGhost) {
                            if(!globalByproducts[outKey]) globalByproducts[outKey] = 0;
                            globalByproducts[outKey] += totalByproduct;
                        } 
                        
                        if (!effectiveGhost) {
                            if(!totalByproducts[outKey]) totalByproducts[outKey] = 0;
                            totalByproducts[outKey] += totalByproduct;
                        }
                    }
                });

                if(!effectiveGhost) {
                    addMachineCount(recipe.machine, item, Math.ceil(machinesNeeded - 0.0001), machinesNeeded);
                }

                // HEAT CALCULATION
                if (DB.machines[recipe.machine] && DB.machines[recipe.machine].heatCost) {
                    const mach = DB.machines[recipe.machine]; const parent = DB.machines[mach.parent];
                    const sReq = mach.slotsRequired || 1; const pSlots = mach.parentSlots || parent.slots || 3;
                    const activeHeat = mach.heatCost * p.speedMult; 
                    
                    const nodeParentsNeeded = Math.ceil((machinesNeeded / (pSlots/sReq)) - 0.0001);
                    const totalHeatPs = (nodeParentsNeeded * parent.heatSelf * p.speedMult) + (machinesNeeded * activeHeat);
                    
                    if (!effectiveGhost) {
                        const pName = mach.parent; 
                        if (!furnaceSlotDemand[pName]) furnaceSlotDemand[pName] = 0;
                        // FIX: Use CEIL() here to count PHYSICAL slots needed, not fractional heat load.
                        furnaceSlotDemand[pName] += Math.ceil(machinesNeeded - 0.0001) * sReq;
                    }
                    
                    // FIX: Always track Global Load (Fixes Summary Box)
                    if (effectiveGhost || !isInternalModule || isInternalModule) {
                        globalHeatLoad += totalHeatPs; 
                        globalFuelDemandItems += (totalHeatPs * 60) / grossFuelEnergy;
                    }
                    
                    if(!effectiveGhost) {
                        heatTag = `<span class="heat-tag">${totalHeatPs.toFixed(1)} P/s ( ${((totalHeatPs * 60) / grossFuelEnergy).toFixed(1)}/m ${p.selectedFuel} )</span>`;
                    }
                }

                if(!effectiveGhost) {
                    let inputsStr = Object.keys(recipe.inputs).map(k => `${recipe.inputs[k]} ${k}`).join(', ');
                    let outputsStr = Object.keys(recipe.outputs).map(k => `${recipe.outputs[k]} ${k}`).join(', ');
                    let cycleTime = recipe.baseTime / p.speedMult;
                    let throughput = effectiveBatchesPerMin * batchYield;
                    let tooltipText = `Recipe: ${inputsStr} -> ${outputsStr}\nBase Time: ${recipe.baseTime}s\nSpeed Mult: ${p.speedMult.toFixed(2)}x\nCycle Time: ${cycleTime.toFixed(2)}s\nThroughput: ${throughput.toFixed(2)} items/min per machine`;

                    let capTag = "";
                    if(p.showMax) {
                        const maxOutput = Math.ceil(machinesNeeded) * throughput;
                        capTag = `<span class="max-cap-tag">(Max: ${formatVal(maxOutput)}/m)</span>`;
                    }
                    machineTag = `<span class="machine-tag" title="${tooltipText}">${Math.ceil(machinesNeeded)} ${t(recipe.machine, 'machines')}${capTag}</span>`;

                    const alts = getRecipesFor(item);
                    if(alts.length > 1) { 
                        swapBtn = `<button class="swap-btn" onclick="openRecipeModal('${item}', this.parentElement)" title="Swap Recipe">ðŸ”„</button>`; 
                    }
                }
                
                // RECURSE INPUTS
                if (netRate > 0.0001) {
                    const netBatches = netRate / batchYield;
                    Object.keys(recipe.inputs).forEach(iName => {
                        let qtyPerBatch = recipe.inputs[iName];
                        let requiredInputRate = netBatches * qtyPerBatch;
                        ingredientChildren.push({ type: 'input', item: iName, rate: requiredInputRate });
                    });
                }
            }
        }

        if (effectiveGhost) {
            ingredientChildren.forEach(child => { 
                buildNode(child.item, child.rate, isInternalModule, currentPath, effectiveGhost); 
            });
            return null; 
        }

        // --- RENDER DOM ---
        const div = document.createElement('div'); div.className = 'node';
        let arrowHtml = `<span class="tree-arrow" style="visibility:${hasChildren ? 'visible' : 'hidden'}" onclick="toggleNode(this)">â–¼</span>`;
        let nodeContent = `
            ${arrowHtml}
            <span class="row-id" onclick="toggleNode(this)">${myRowID})</span>
            <span class="qty">${formatVal(rate)}/m</span>
            <span class="item-link" onclick="openDrillDown('${item}', ${rate})"><strong>${item}</strong></span>
            ${swapBtn}
            ${detailsTag}
            ${costTag}
            ${machineTag}
            ${bioTag}
            ${heatTag}
            ${outputTag}
            ${recycleTag}
        `;

        div.innerHTML = `<div class="node-content" data-ancestors='${JSON.stringify(ancestors)}'>${nodeContent}</div>`;
        if (ingredientChildren.length > 0) {
            const childrenDiv = document.createElement('div');
            childrenDiv.className = 'node-children';
            ingredientChildren.forEach(child => { 
                childrenDiv.appendChild(buildNode(child.item, child.rate, isInternalModule, currentPath, effectiveGhost)); 
            });
            div.appendChild(childrenDiv);
        }
        return div;
    }

    // --- EXECUTE THE PASS ---
    if(p.targetItem) {
        const root = buildNode(p.targetItem, grossRate, false, []);
        if(!isGhost) {
            const h = document.createElement('div'); h.className = 'section-header'; h.innerText = `--- ${t('Primary Production Chain')} (${p.targetItem}) ---`; treeContainer.appendChild(h); 
            treeContainer.appendChild(root);
        }
    }

    if (!isGhost) {
        let stableFuelDemand = globalFuelDemandItems;
        let stableFertDemand = globalFertDemandItems;
        let byproductSnapshot = {...globalByproducts}; 
        
        let baseFuel = globalFuelDemandItems;
        let baseFert = globalFertDemandItems;
        let baseHeat = globalHeatLoad;
        let baseBio = globalBioLoad;
        let baseCost = globalCostPerMin;
        
        if (p.selfFeed || p.selfFert) {
            for(let i=0; i<10; i++) {
                globalFuelDemandItems = baseFuel;
                globalFertDemandItems = baseFert;
                globalHeatLoad = baseHeat;
                globalBioLoad = baseBio;
                globalCostPerMin = baseCost;
                
                globalByproducts = {...byproductSnapshot}; 
                
                let prevFuel = stableFuelDemand;
                let prevFert = stableFertDemand;
                
                if (p.selfFert && prevFert > 0) {
                    buildNode(p.selectedFert, prevFert, true, [], true); 
                }
                
                if (p.selfFeed && prevFuel > 0) {
                    buildNode(p.selectedFuel, prevFuel, true, [], true); 
                }
                
                let nextFuel = globalFuelDemandItems;
                let nextFert = globalFertDemandItems;
                
                if (Math.abs(nextFuel - prevFuel) < 0.01 && Math.abs(nextFert - prevFert) < 0.01) {
                    stableFuelDemand = nextFuel;
                    stableFertDemand = nextFert;
                    break;
                }
                stableFuelDemand = nextFuel;
                stableFertDemand = nextFert;
            }
        }
        
        globalFuelDemandItems = stableFuelDemand;
        globalFertDemandItems = stableFertDemand;
        
        if (!isGhost) {
            if (p.selfFert && stableFertDemand > 0) {
                const grossFertNeeded = stableFertDemand;
                if (p.targetItem === p.selectedFert) {
                    const note = document.createElement('div'); note.innerHTML = `<div class="node" style="margin-top:20px; color:#aaa; font-style:italic;">Internal Nutrient Source: <strong>${p.selectedFert}</strong> (Supplied by Main Output)<br>Total Required: ${grossFertNeeded.toFixed(1)}/m</div>`; treeContainer.appendChild(note);
                } else {
                    const h = document.createElement('div'); h.className = 'section-header'; h.innerText = `--- ${t('Internal Nutrient Module')} (${p.selectedFert}) ---`; treeContainer.appendChild(h); rowCounter=0; 
                    treeContainer.appendChild(buildNode(p.selectedFert, grossFertNeeded, true, []));
                }
            }

            if (p.selfFeed && stableFuelDemand > 0) {
                const grossFuelNeeded = stableFuelDemand;
                if (p.targetItem === p.selectedFuel) {
                    const note = document.createElement('div'); note.innerHTML = `<div class="node" style="margin-top:20px; color:#aaa; font-style:italic;">Internal Fuel Source: <strong>${p.selectedFuel}</strong> (Supplied by Main Output)<br>Total Required: ${grossFuelNeeded.toFixed(1)}/m</div>`; treeContainer.appendChild(note);
                } else {
                    const h = document.createElement('div'); h.className = 'section-header'; h.innerText = `--- ${t('Internal Heat Module')} (${p.selectedFuel}) ---`; treeContainer.appendChild(h); rowCounter=0; 
                    treeContainer.appendChild(buildNode(p.selectedFuel, grossFuelNeeded, true, []));
                }
            }
        }
    }

    if (!isGhost) {
        // --- SUMMARY & EXTERNALS ---
        const extH = document.createElement('div'); extH.className = 'section-header'; extH.innerText = `--- External Inputs ---`; treeContainer.appendChild(extH);
        const extDiv = document.createElement('div'); extDiv.className = 'node';
        let extHTML = `<div class="node-content" style="margin-bottom:5px;"><span class="qty" style="color:var(--gold)">${Math.ceil(globalCostPerMin).toLocaleString()} G/m</span><strong>${t('Raw Material Cost')}</strong></div>`;
        if (!p.selfFeed && globalFuelDemandItems > 0) { extHTML += `<div class="node-content" style="margin-bottom:5px;"><span class="qty" style="color:var(--fuel)">${globalFuelDemandItems.toFixed(1)}/m</span><strong>${p.selectedFuel}</strong> (${t('Fuel Import')})</div>`; }
        if (!p.selfFert && globalFertDemandItems > 0) { extHTML += `<div class="node-content" style="margin-bottom:5px;"><span class="qty" style="color:var(--bio)">${globalFertDemandItems.toFixed(1)}/m</span><strong>${p.selectedFert}</strong> (${t('Fertilizer Import')})</div>`; }
        extDiv.innerHTML = extHTML; treeContainer.appendChild(extDiv);

        const bypHeader = document.createElement('div'); bypHeader.className = 'section-header'; bypHeader.innerText = `--- BYPRODUCTS ---`; treeContainer.appendChild(bypHeader);
        const bypDiv = document.createElement('div'); bypDiv.className = 'node';
        let bypHTML = '';
        const sortedByproducts = Object.keys(totalByproducts).sort();
        if (sortedByproducts.length > 0) {
            sortedByproducts.forEach(item => {
                let remaining = globalByproducts[item] || 0; 
                let note = "";
                if (remaining < totalByproducts[item]) {
                    note = ` <span style="font-size:0.8em; color:#888;">(${formatVal(totalByproducts[item] - remaining)} ${t(`recycled`, `ui`)})</span>`;
                }
                bypHTML += `<div class="node-content"><span class="qty" style="color:var(--byproduct)">${formatVal(remaining)}/m</span><strong>${item}</strong>${note}</div>`;
            });
        } else {
            bypHTML = `<div class="node-content"><span class="details" style="font-style:italic">${t('None')}</span></div>`;
        }
        bypDiv.innerHTML = bypHTML; treeContainer.appendChild(bypDiv);

        // --- FLATTEN AGGREGATION FOR UI ---
        let flatMax = {};
        let flatMin = {};
        
        Object.keys(machineStats).forEach(mName => {
            let totalIntMax = 0;
            let totalCeiledMin = 0;
            
            Object.keys(machineStats[mName]).forEach(outItem => {
                const data = machineStats[mName][outItem];
                totalIntMax += data.nodeSumInt;
                totalCeiledMin += Math.ceil(data.rawFloat - 0.0001);
            });
            
            flatMax[mName] = totalIntMax;
            flatMin[mName] = totalCeiledMin;
        });

        // CALCULATE FINAL FURNACE COUNT FROM SLOTS
        let totalFurnaces = 0;
        Object.keys(furnaceSlotDemand).forEach(parentName => {
            const parentDef = DB.machines[parentName];
            if (parentDef) {
                totalFurnaces += Math.ceil((furnaceSlotDemand[parentName] - 0.0001) / (parentDef.slots || 3));
            }
        });

        updateConstructionList(flatMax, flatMin, totalFurnaces);
        
        // Pass the actual simulated fuel/fert demand items to the summary
        updateSummaryBox(p, globalHeatLoad, globalBioLoad, globalCostPerMin, grossRate, globalFuelDemandItems, globalFertDemandItems);
    }
}

/* ==========================================================================
   SECTION: JS - DOM RENDERING
   ========================================================================== */
function updateConstructionList(maxCounts, minCounts, furnaces) {
    const buildList = document.getElementById('construction-list'); buildList.innerHTML = '';
    const totalMatsContainer = document.getElementById('total-mats-container'); totalMatsContainer.innerHTML = '';
    
    // Check if we are in MAX mode
    const isMaxMode = !document.getElementById('buildModeToggle').checked;
    
    const sortedMachines = Object.keys(maxCounts).sort();
    let totalConstructionMaterials = {};

    sortedMachines.forEach(m => {
        const countMax = maxCounts[m]; 
        const countMin = Math.ceil(minCounts[m]);
        if(countMax <= 0) return;
        
        // Decide which count to use for material calculation
        const activeCount = isMaxMode ? countMax : countMin;
        
        let label = (countMax === countMin) ? `${countMax}` : 
                    isMaxMode ? `<span>${countMax}</span>` : 
                    `<span style="color:var(--accent)">${countMin}</span>`;

        const li = document.createElement('li'); li.className = 'build-group';
        const machineDef = DB.machines[m] || {};
        const buildCost = machineDef.buildCost;

        let subListHtml = '';
        if (buildCost) {
            subListHtml = `<ul class="build-sublist">`;
            Object.keys(buildCost).forEach(mat => {
                // Calculation based on activeCount
                const totalQty = buildCost[mat] * activeCount;
                subListHtml += `<li class="build-subitem"><span>${mat}</span> <span class="build-val">${totalQty}</span></li>`;
                if(!totalConstructionMaterials[mat]) totalConstructionMaterials[mat] = 0;
                totalConstructionMaterials[mat] += totalQty;
            });
            subListHtml += `</ul>`;
        }
        li.innerHTML = `<div class="build-header" onclick="toggleBuildGroup(this.parentNode)"><span><span class="build-arrow">â–¶</span> ${t(m, 'machines')}</span> <span class="build-count">${label}</span></div>${subListHtml}`;
        buildList.appendChild(li);
    });

    // Stone Furnaces (Calculated as shared sources, but can scale in MAX mode if nodes are separate)
    if(furnaces > 0) {
        const li = document.createElement('li'); li.className = 'build-group';
        const mName = "Stone Furnace";
        // If MAX mode, furnaces usually increase because machines are spread out
        // For simplicity, we keep it as 'furnaces' but you could implement a max-furnace logic if needed
        const count = furnaces; 
        const machineDef = DB.machines[mName] || {}; const buildCost = machineDef.buildCost;
        let subListHtml = '';
        if (buildCost) {
            subListHtml = `<ul class="build-sublist">`;
            Object.keys(buildCost).forEach(mat => {
                const totalQty = buildCost[mat] * count;
                subListHtml += `<li class="build-subitem"><span>${mat}</span> <span class="build-val">${totalQty}</span></li>`;
                if(!totalConstructionMaterials[mat]) totalConstructionMaterials[mat] = 0;
                totalConstructionMaterials[mat] += totalQty;
            });
            subListHtml += `</ul>`;
        }
        li.innerHTML = `<div class="build-header" style="border-top:1px dashed #555" onclick="toggleBuildGroup(this.parentNode)"><span><span class="build-arrow">â–¶</span> ${t('Stone Furnace', 'machines')}</span> <span class="build-count" style="color:var(--warn)">${count}</span></div>${subListHtml}`;
        buildList.appendChild(li);
    }

    // Render Total Section
    if (Object.keys(totalConstructionMaterials).length > 0) {
        let totalHtml = `<div class="total-mats-header">${t('Total Materials Required')}</div>`;
        Object.keys(totalConstructionMaterials).sort().forEach(mat => {
            totalHtml += `<div class="total-mat-item"><span>${mat}</span> <strong>${totalConstructionMaterials[mat]}</strong></div>`;
        });
        totalMatsContainer.innerHTML = totalHtml;
    }

    updateBuildModeLabel();
}

function updateBuildModeLabel() {
    const isMinMode = document.getElementById('buildModeToggle').checked;
    document.getElementById('build-mode-label').classList.toggle('active-mode', isMinMode);
    document.getElementById('build-mode-label').innerText = isMinMode ? "MIN" : "MAX";
}

function updateSummaryBox(p, heat, bio, cost, grossRate, actualFuelNeed, actualFertNeed) {
    const targetItemDef = DB.items[p.targetItem] || {};
    let internalHeat = p.selfFeed ? heat : 0;
    let externalHeat = !p.selfFeed ? heat : 0;
    let internalBio = p.selfFert ? bio : 0;
    let externalBio = !p.selfFert ? bio : 0;

    let profitHtml = "";
    if (targetItemDef.sellPrice) {
        const revenuePerMin = p.targetRate * targetItemDef.sellPrice;
        const profit = revenuePerMin - cost;
        profitHtml = `<div class="stat-block"><span class="stat-label">Projected Profit</span><span class="stat-value ${profit >= 0 ? 'gold-profit' : 'gold-cost'}">${Math.floor(profit).toLocaleString()} G/m</span></div>`;
    } else {
        profitHtml = `<div class="stat-block"><span class="stat-label">Total Raw Cost</span><span class="stat-value gold-cost">${Math.ceil(cost).toLocaleString()} G/m</span></div>`;
    }

    let deductionText = [];
    
    // FIX: Correctly calculate Gross as (Target + Use)
    if (p.selfFeed && p.targetItem === p.selectedFuel) { 
        let gross = p.targetRate + actualFuelNeed;
        deductionText.push(`Gross: ${gross.toFixed(1)}`); 
        deductionText.push(`Use: ${actualFuelNeed.toFixed(1)}`); 
    }
    
    if (p.selfFert && p.targetItem === p.selectedFert) { 
        let gross = p.targetRate + actualFertNeed;
        deductionText.push(`Gross: ${gross.toFixed(1)}`); 
        deductionText.push(`Use: ${actualFertNeed.toFixed(1)}`); 
    }

    document.getElementById('summary-container').innerHTML = `
        <div class="summary-box">
            <div class="stat-block"><span class="stat-label">Net Output</span><span class="stat-value ${p.targetRate >= 0 ? 'net-positive' : 'net-warning'}">${p.targetRate.toFixed(1)} / min</span>${deductionText.length > 0 ? `<span class="stat-sub" style="font-size:0.75em">${deductionText.join('<br>')}</span>` : ''}</div>
            <div class="stat-block"><span class="stat-label">Internal Load</span><span class="stat-value" style="font-size:0.9em; color:var(--fuel);">${t('Heat')}: ${internalHeat.toFixed(1)} P/s</span><span class="stat-value" style="font-size:0.9em; color:var(--bio);">${t('Nutr')}: ${formatVal(internalBio)} V/s</span></div>
            <div class="stat-block"><span class="stat-label">External Load</span><span class="stat-value" style="font-size:0.9em; color:var(--fuel);">${t('Heat')}: ${externalHeat.toFixed(1)} P/s</span><span class="stat-value" style="font-size:0.9em; color:var(--bio);">${t('Nutr')}: ${formatVal(externalBio)} V/s</span></div>
            ${profitHtml}
            <div class="stat-block"><span class="stat-label">Belt Usage (Net)</span><span class="stat-value" style="font-size:1.1em; color:${p.targetRate > p.beltSpeed ? '#ff5252' : '#aaa'};">${(p.targetRate/p.beltSpeed * 100).toFixed(0)}%</span><span class="stat-sub">${t('Cap')}: ${p.beltSpeed}/m</span></div>
        </div>`;
}

init();
</script>
</body>
</html>