<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alchemy Factory Calculator</title>
    <script src="alchemy_db.js"></script> 
    <script src="alchemy_constants.js"></script> 
    <script src="alchemy_i18n.js"></script>
    <link rel="stylesheet" href="style.css">

</head>
<body>
    <div id="update-banner">
        <span>
        üöÄ <span id="ui-update-msg">New database version available</span> (<span id="new-version-id">v0</span>)! 
            <span id="ui-update-local-msg">Current local version:</span> <span id="old-version-id">v0</span>
        </span>
        <div class="update-btns">
            <button id="ui-btn-update" class="update-btn" onclick="performUpdate()">Update Now</button>
            <button id="ui-btn-later" class="update-btn secondary" onclick="closeUpdateBanner()">Skip Update</button>
        </div>
    </div>

    <header>
        <div style="display:flex; align-items:baseline;">
            <h1>Alchemy Factory Calculator</h1>
            <span style="margin-left: 10px;">
                <span id="ui-lang-toggle" style="cursor:pointer;" onclick="toggleLanguage()" title="EN/‰∏≠Êñá">üåê</span>
                <a href="https://github.com/starfi5h/AlchemyFactoryCalculator" target="_blank" class="repo-link">GitHub Repo</a>
                <span id="last-updated-time-text">2025.01.08</span>
            </span>
        </div>
        <div class="tabs">
            <div class="tab-btn active" onclick="switchTab('calc')">Calculator</div>
            <div class="tab-btn" onclick="switchTab('cauldron')">Cauldron</div>
            <div class="tab-btn" onclick="switchTab('db')">Database Editor</div>
        </div>
    </header>

    <main>
        <div id="recipe-modal" class="modal-overlay" onclick="closeModal('recipe-modal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h2 id="recipe-modal-title">Select Recipe</h2>
                    <button class="close-modal" onclick="closeModal('recipe-modal')">&times;</button>
                </div>
                <div id="recipe-list"></div>
            </div>
        </div>

        <!-- Item Picker Modal -->
        <div id="picker-modal" class="modal-overlay" onclick="closeModal('picker-modal')">
            <div class="modal-content picker-modal-content" style="width: 800px; max-width: 95vw;" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <h2 id="ui-picker-title" style="margin:0;">Select Target Item</h2>
                        <!-- New toggle buttons -->
                        <div class="picker-controls">
                            <button id="ui-picker-expand-all" class="split-btn" onclick="toggleAllCategories(false)">Expand All</button>
                            <button id="ui-picker-collapse-all" class="split-btn" onclick="toggleAllCategories(true)">Collapse All</button>
                            <span id="ui-picker-saleable-only" style="font-size:0.75em; font-weight:bold;">Goods</span>
                            <label class="switch">
                                <input type="checkbox" id="productFilterToggle" onchange="openItemPicker()">
                                <span class="slider-switch"></span>
                            </label>
                            <span><input type="text" id="itmePickerInput" placeholder="Search items..." autocomplete="off" oninput="renderItemPicker()"></span>
                        </div>
                    </div>
                    <button class="close-modal" onclick="closeModal('picker-modal')">&times;</button>
                </div>
                <!-- Scrollable area is separate from header -->
                <div id="picker-body" class="picker-scroll-area">
                    <!-- Categories will be injected here -->
                </div>
            </div>
        </div>

        <div id="view-calc" class="view active">
            <div class="app-grid">
                <div>
                    <div class="panel">
                        <h3>Production Goal</h3>
                        <div class="input-group">
                            <label>Target Item</label>
                            <div class="combobox-container" id="targetCombobox">
                                <div class="input-wrapper" onclick="toggleCombobox()">
                                    <div id="ghost-text" class="ghost-input"></div>
                                    <input type="text" id="targetItemInput" class="real-input" placeholder="Select or Type..." autocomplete="off" oninput="filterCombobox(); updateComboIcon();" onkeydown="handleComboKey(event)" onblur="closeComboboxDelayed()">
                                    <div class="combo-arrow" onclick="openItemPicker()" title="Browse Items">‚ò∞</div>
                                    <div id="combo-btn" class="combo-arrow" onclick="handleComboIconClick(event)">‚ñº</div>
                                </div>
                                <div id="combobox-list" class="combobox-list"></div>
                            </div>
                        </div>

                        <!-- Ê®°ÂºèÂàáÊèõÈñãÈóú -->
                        <div class="checkbox-row" style="margin-bottom: 5px;">
                            <input type="checkbox" id="machineModeToggle" onchange="toggleControlMode(true)">
                            <label for="machineModeToggle" style="display:inline; margin:0; cursor:pointer; font-weight:bold; color:var(--accent);">
                                Set by Machine Count
                            </label>
                        </div>
                        
                        <!-- Ê©üÂô®Êï∏ÈáèËº∏ÂÖ• -->
                        <div class="input-group" style="opacity:0.5" id="group-machine" disabled>
                            <label id="machineLabel">Machine Count</label> <label id="active-machine-name">(None)</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustMachine(-1)">-1</button>
                                <button class="spinner-btn left" onclick="adjustMachine(-0.1)">-0.1</button>
                                <input type="number" id="targetMachine" value="1" oninput="calculate()" disabled>
                                <button class="spinner-btn right" onclick="adjustMachine(0.1)">+0.1</button>
                                <button class="spinner-btn right last" onclick="adjustMachine(1)">+1</button>
                            </div>
                        </div>

                        <!-- ÈÄüÁéáËº∏ÂÖ• -->
                        <div class="input-group" id="group-rate">
                            <label id="rateLabel">Rate (Items/Min)</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustRate(-1)">-1</button>
                                <button class="spinner-btn left" onclick="adjustRate(-0.1)">-0.1</button>
                                <input type="number" id="targetRate" value="60" oninput="calculate()">
                                <button class="spinner-btn right" onclick="adjustRate(0.1)">+0.1</button>
                                <button class="spinner-btn right last" onclick="adjustRate(1)">+1</button>
                            </div>
                        </div>

                        <div class="input-group" style="margin-bottom:20px;">
                            <label>Belt Load Fraction</label>
                            <div class="slider-container">
                                <input type="range" id="beltSlider" min="0" max="100" step="1" oninput="updateFromSlider()">
                                <div id="sliderTicks" class="slider-ticks"></div>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <h3>Logistics</h3>
                        <div class="input-group">
                            <div>
                                <label>Heat Source</label>
                                <span id="fuelEfficiencyCostByHeat" class="cost-tag">0.000 G/P</span> | 
                                <span id="fuelEfficiencyHeatByCost" class="heat-tag" style="margin-left:auto">00.00 P/G</span>
                            </div>
                            <select id="fuelSelect" onchange="updateDefaultButtonState(); calculate();"></select>
                            <input type="checkbox" id="selfFuel" style="display:none;">
                            <div class="split-btn-container">
                                <button id="btnSelfFuel" class="split-btn btn-inactive-red" onclick="toggleFuel()">Self-Fuel: OFF</button>
                                <button id="btnDefFuel" class="split-btn" onclick="setDefaultFuel()">Make Default</button>
                            </div>
                            <div class="checkbox-row">
                                <input type="checkbox" checked id="fuelCostEnable" onchange="onLogisticsChange()">
                                <label for="fuelCostEnable" style="display:inline; margin:0; cursor:pointer;">Cost (G/item):</label>
                                <input type="number" id="fuelCostInput" class="small-num-input" value="0" oninput="onLogisticsChange()">
                            </div>
                        </div>
                        <div class="input-group">
                            <div>
                                <label>Fertilizer Source</label>
                                <span id="fertEfficiencyCostByNutr" class="cost-tag">0.000 G/V</span> | 
                                <span id="fertEfficiencyNutrByCost" class="bio-tag" style="margin-left:auto">00.00 V/G</span>
                            </div>
                            <select id="fertSelect" onchange="updateDefaultButtonState(); calculate();"></select>
                            <input type="checkbox" id="selfFert" style="display:none;">
                            <div class="split-btn-container">
                                <button id="btnSelfFert" class="split-btn btn-inactive-red" onclick="toggleFert()">Self-Fert: OFF</button>
                                <button id="btnDefFert" class="split-btn" onclick="setDefaultFert()">Make Default</button>
                            </div>
                            <div class="checkbox-row">
                                <input type="checkbox" checked id="fertCostEnable" onchange="onLogisticsChange()">
                                <label for="fertCostEnable" style="display:inline; margin:0; cursor:pointer;">Cost (G/item):</label>
                                <input type="number" id="fertCostInput" class="small-num-input" value="0" oninput="onLogisticsChange()">
                            </div>
                        </div>
                        <div class="checkbox-row">
                            <input type="checkbox" id="showMaxCap" onchange="onLogisticsChange()">
                            <label for="showMaxCap" style="display:inline; margin:0; cursor:pointer;">Show Machine Max Cap</label>
                        </div>
                        <div class="checkbox-row">
                            <input type="checkbox" id="showHeatFert" onchange="onLogisticsChange()">
                            <label for="showHeatFert" style="display:inline; margin:0; cursor:pointer;">Show Machine Heat & Nutr</label>
                        </div>
                    </div>
                </div>

                <div id="results-area">
                    <div id="summary-container"></div>
                    <div id="summary-icons"></div>
                    <div id="tree"></div>
                </div>

                <div>
                    <div class="panel">
                        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; margin-bottom:10px; padding-bottom:8px;">
                            <h3 style="margin:0; border:none; padding:0;">Construction List</h3>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span id="build-mode-label" style="font-size:0.8em; color:#ccc; font-weight:bold;">MAX</span>
                                <label class="switch">
                                    <input type="checkbox" id="buildModeToggle" onchange="updateBuildModeLabel(); calculate();">
                                    <span class="slider-switch"></span>
                                </label>
                            </div>
                        </div>
                        <ul id="construction-list" class="build-list"></ul>
                        <div id="total-mats-container"></div>
                    </div>
                </div>

                <div>
                    <div class="panel">
                        <h3>Upgrades (Levels)</h3>
                        <div class="input-group">
                            <label id="lvlBelt-title">Logistics Efficiency</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustInput('lvlBelt', -1); updateFromSlider();">-</button>
                                <input type="number" id="lvlBelt" value="0" min="0" oninput="updateFromSlider()">
                                <button class="spinner-btn right last" onclick="adjustInput('lvlBelt', 1); updateFromSlider();">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label id="lvlSpeed-title">Factory Efficiency</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustInput('lvlSpeed', -1); calculate();">-</button>
                                <input type="number" id="lvlSpeed" value="0" min="0" oninput="calculate()">
                                <button class="spinner-btn right last" onclick="adjustInput('lvlSpeed', 1); calculate();">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label id="lvlAlchemy-title">Alchemy Skill</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustInput('lvlAlchemy', -1); calculate();">-</button>
                                <input type="number" id="lvlAlchemy" value="0" min="0" oninput="calculate()">
                                <button class="spinner-btn right last" onclick="adjustInput('lvlAlchemy', 1); calculate();">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label id="lvlFuel-title">Fuel Efficiency</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustInput('lvlFuel', -1); calculate();">-</button>
                                <input type="number" id="lvlFuel" value="0" min="0" oninput="calculate()">
                                <button class="spinner-btn right last" onclick="adjustInput('lvlFuel', 1); calculate();">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label id="lvlFert-title">Fert Efficiency</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustInput('lvlFert', -1); calculate();">-</button>
                                <input type="number" id="lvlFert" value="0" min="0" oninput="calculate()">
                                <button class="spinner-btn right last" onclick="adjustInput('lvlFert', 1); calculate();">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <h3>Save/Reset</h3>
                        <button class="save-btn" onclick="saveSettings()">Save Upgrades</button>
                        <div style="text-align:center; margin-top:15px;">
                            <button class="reset-btn" onclick="resetToDefault()">Factory Reset</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-cauldron" class="view">
            <div class="cauldron-grid">
                <div class="panel scroll-panel">
                    <h3>Settings & Candidates</h3>
                    <div class="cauldron-tabs-row">
                        <button id="cauldron-tab-0" class="tab-btn mini-tab active" onclick="switchCauldronProfile(0)">Profile 1</button>
                        <button id="cauldron-tab-1" class="tab-btn mini-tab" onclick="switchCauldronProfile(1)">Profile 2</button>
                        <button id="cauldron-tab-2" class="tab-btn mini-tab" onclick="switchCauldronProfile(2)">Profile 3</button>
                    </div>
                    <div class="input-group" style="margin-bottom:2px;">
                        <label>Filter Category</label>
                        <select id="cauldron-cat-select" onchange="renderCandidatePool()"></select>
                    </div>
                    <div class="split-btn-container">
                        <button class="split-btn" onclick="bulkToggleCandidates(true)">Select All</button>
                        <button class="split-btn" onclick="bulkToggleCandidates(false)">Deselect All</button>
                    </div>
                    <div class="checkbox-row" style="margin-top:10px;">
                        <input type="checkbox" id="cauldron-sort-by-cost" checked onchange="renderCandidatePool()">
                        <label for="cauldron-sort-by-cost" style="display:inline; margin:0; cursor:pointer; font-size: 1.0em;">Sort by Value</label>                        
                        <input type="checkbox" id="cauldron-real-time-calculation" style="margin-left:auto;">
                        <label for="cauldron-real-time-calculation" style="display:inline; margin:0; cursor:pointer; font-size: 1.0em;">Real-time calculation</label>
                    </div>
                    <div id="candidate-pool" class="candidate-list">
                    </div>
                </div>

                <div class="cauldron-main">
                    <div class="panel">
                        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:10px;">
                            <div style="display:flex; align-items:baseline; gap:10px;">
                                <h3 style="border:none; margin:0;">Matching Results</h3>
                                <span id="cauldron-progress" style="color:var(--accent); font-size:0.9em; font-weight:bold;"></span>
                            </div>
                            <button id="btn-run-cauldron" class="save-btn" style="width:auto; padding:5px 15px;" onclick="runCauldronSimulation()">Calculate All</button>
                        </div>

                        <div class="cauldron-filter-bar">
                            <div class="filter-group">
                                <div class="mini-picker" id="slot1" onclick="pickFilterItem(1)">Set Item 1</div>
                                <button class="swap-btn" title="clear input 1" onclick="pickFilterItem(1,true); runCauldronSimulation();">√ó</button>
                                <div class="mini-picker" id="slot2" onclick="pickFilterItem(2)">Set Item 2</div>
                                <button class="swap-btn" title="clear input 2" onclick="pickFilterItem(2,true); runCauldronSimulation();">√ó</button>
                            </div>
                            <div class="filter-group">
                                <div class="checkbox-row"><input type="checkbox" id="f-ratio-100" checked onchange="runCauldronSimulation()"><label style="display:flex; font-size: 1.0em;">3 Diff</label></div>
                                <div class="checkbox-row"><input type="checkbox" id="f-ratio-065" checked onchange="runCauldronSimulation()"><label style="display:flex; font-size: 1.0em;">2 Same</label></div>
                                <div class="checkbox-row"><input type="checkbox" id="f-ratio-050" checked onchange="runCauldronSimulation()"><label style="display:flex; font-size: 1.0em;">3 Same</label></div>
                            </div>
                        </div>
                        
                        <div id="cauldron-results"></div>

                        <div id="unattainable-section" style="margin-top:20px; display:none;">
                            <h3 style="color:var(--danger); border-bottom:1px solid var(--danger); font-size:0.9em; margin-bottom:10px;">Unattainable Targets</h3>
                            <div id="unattainable-list" class="picker-grid compact-grid"></div>
                        </div>
                    </div>
                </div>

                <div class="panel scroll-panel">
                    <h3>Saved Recipes</h3>
                        <div class="split-btn-container" style="margin-bottom: 10px;">
                            <button class="split-btn" onclick="importCauldronFavorites()" style="font-size:0.9em;">Import</button>
                            <button class="split-btn" onclick="exportCauldronFavorites()" style="font-size:0.9em;">Export</button>
                            <button class="split-btn" onclick="syncCauldronToMainDB(true)" style="font-size:0.9em; color:white;">Sync DB</button>
                        </div>
                    <div id="cauldron-favorites" class="fav-list">
                    </div>
                </div>
            </div>
        </div>

        <div id="view-db" class="view">
            <div class="editor-container">
                <div class="editor-toolbar">
                    <!-- Add a selector to switch between DB and I18N -->
                    <select id="editor-target" onchange="loadEditorContent()" style="width: auto; padding: 5px;">
                        <option value="db">Database</option>
                        <option value="i18n">Translations</option>
                        <option value="db_backup">(BACKUP) Database</option>
                        <option value="i18n_backup">(BACKUP) Translations</option>
                    </select>
                    <button class="save-btn" onclick="applyChanges()" style="width:auto; margin:0;">Apply Changes</button>
                    <button class="info" onclick="exportData()" style="padding:10px; background:var(--info); border:none; color:white; border-radius:4px; font-weight:bold; cursor:pointer;">Export to File</button>
                </div>
                <textarea id="json-editor"></textarea>
            </div>
        </div>
    </main>
    
    <script src="alchemy_ui.js"></script>
    <script src="alchemy_calc.js"></script>       
    <script src="alchemy_cauldron.js"></script>
</body>
</html>